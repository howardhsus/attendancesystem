<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台北101打卡系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root {
      --primary-color: #06C755;
      --error-color: #E74C3C;
      --success-color: #2ECC71;
      --info-color: #3498DB;
      --text-color: #333333;
      --border-color: #DDDDDD;
      --bg-color: #F5F5F5;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
      max-width: 100%;
      min-height: 100vh;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .container {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    
    #loading {
      text-align: center;
      padding: 40px 20px;
      font-size: 18px;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary-color);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    h1, h2 {
      color: var(--text-color);
      margin-bottom: 20px;
    }
    
    h1 {
      font-size: 24px;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 10px;
    }
    
    h2 {
      font-size: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
    }
    
    .tab {
      display: flex;
      margin-bottom: 20px;
      border-radius: 5px;
      overflow: hidden;
      background-color: #F0F0F0;
    }
    
    .tab button {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .tab button.active {
      background: var(--primary-color);
      color: white;
      font-weight: bold;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 15px;
    }
    
    input, select {
      width: 100%;
      padding: 12px 15px;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      font-size: 16px;
      transition: border 0.3s;
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #05A84D;
    }
    
    button:disabled {
      background: #CCCCCC;
      cursor: not-allowed;
    }
    
    .btn-retry {
      background: var(--info-color);
      margin-top: 10px;
    }
    
    .btn-retry:hover {
      background: #2980B9;
    }
    
    .record {
      border: 1px solid var(--border-color);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      background: white;
    }
    
    .record p {
      margin: 8px 0;
    }
    
    .record strong {
      color: var(--text-color);
    }
    
    .message {
      padding: 12px 15px;
      border-radius: 5px;
      margin: 15px 0;
      font-size: 15px;
    }
    
    .error {
      color: var(--error-color);
      background: #FDECEA;
      border: 1px solid #F5C3BB;
    }
    
    .success {
      color: var(--success-color);
      background: #E8F8F0;
      border: 1px solid #C8E6D3;
    }
    
    .info {
      color: var(--info-color);
      background: #EBF5FB;
      border: 1px solid #D4E6F1;
    }
    
    #locationStatus {
      font-weight: bold;
      margin: 20px 0;
      padding: 12px;
      border-radius: 5px;
    }
    
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #777777;
      font-size: 13px;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 15px;
      }
      
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      h2 {
        font-size: 18px;
      }
      
      button, input {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <p>系統初始化中，請稍候...</p>
  </div>
  
  <!-- 註冊容器 -->
  <div id="registerContainer" class="container">
    <h1>員工註冊</h1>
    <div class="form-group">
      <label for="name">姓名</label>
      <input type="text" id="name" placeholder="請輸入您的姓名" required>
    </div>
    <div class="form-group">
      <label for="employeeId">識別證卡號</label>
      <input type="text" id="employeeId" placeholder="請輸入您的員工編號" required>
    </div>
    <button id="registerBtn">註冊</button>
    <div id="registerMessage"></div>
  </div>
  
  <!-- 主容器 -->
  <div id="mainContainer" class="container">
    <h1 id="greeting">台北101打卡系統</h1>
    
    <div class="tab">
      <button id="attendanceTab" class="active">打卡</button>
      <button id="recordsTab">查詢記錄</button>
    </div>
    
    <!-- 打卡內容 -->
    <div id="attendanceContent">
      <div id="locationStatus" class="info">
        <p>正在取得定位資訊...</p>
      </div>
      <button id="checkInBtn" disabled>上班打卡</button>
      <button id="checkOutBtn" disabled>下班打卡</button>
      <div id="attendanceMessage"></div>
    </div>
    
    <!-- 記錄查詢內容 -->
    <div id="recordsContent" style="display: none;">
      <div class="form-group">
        <label for="recordDate">查詢日期</label>
        <input type="date" id="recordDate">
      </div>
      <button id="queryBtn">查詢記錄</button>
      <div id="recordsList"></div>
    </div>
  </div>
  
  <div class="footer">
    <p>台北101清潔出勤系統 &copy; 2023</p>
  </div>

  <script>
    // 配置
    const config = {
      backendUrl: 'https://script.google.com/macros/s/AKfycbx5I9vg9m7nTmkb0qrU8gMGXeguzVJ__ALYnqZPLdxTXTbmQr0x4voXcS_l1HpqCsw/exec' // 替換為您的Google Apps Script URL
    };
    
    // 全局變量
    let userId = null;
    let isRegistered = false;
    let currentLocation = null;
    let userName = '';
    let employeeId = '';
    
    // 初始化LIFF應用
    async function initializeLiff() {
      try {
        // 顯示加載狀態
        document.getElementById('loading').style.display = 'block';
        document.getElementById('registerContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'none';
        
        // 初始化LIFF SDK
        await liff.init({ liffId: '2007700262-da76ZbYE' }); // 替換為您的LIFF ID
        
        // 檢查登入狀態
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        // 獲取用戶資料
        const profile = await liff.getProfile();
        userId = profile.userId;
        
        // 檢查註冊狀態（最多重試3次）
        let retryCount = 0;
        const maxRetries = 3;
        let registrationChecked = false;
        
        while (retryCount < maxRetries && !registrationChecked) {
          try {
            isRegistered = await checkRegistration();
            registrationChecked = true;
          } catch (error) {
            retryCount++;
            console.warn(`檢查註冊狀態失敗 (${retryCount}/${maxRetries}):`, error);
            
            if (retryCount < maxRetries) {
              // 等待1秒後重試
              await new Promise(resolve => setTimeout(resolve, 1000));
            } else {
              throw error;
            }
          }
        }
        
        // 根據註冊狀態顯示相應界面
        document.getElementById('loading').style.display = 'none';
        if (isRegistered) {
          showMainApp();
        } else {
          document.getElementById('registerContainer').style.display = 'block';
        }
        
        // 獲取地理位置
        getLocation();
        
      } catch (error) {
        console.error('初始化失敗:', error);
        document.getElementById('loading').innerHTML = `
          <div class="error message">
            <p>系統初始化失敗</p>
            <p><small>${error.message || '未知錯誤'}</small></p>
            <button class="btn-retry" onclick="window.location.reload()">重新載入</button>
          </div>
        `;
      }
    }
    
    // 檢查註冊狀態
    async function checkRegistration() {
      try {
        // 添加時間戳防止緩存
        const timestamp = Date.now();
        const url = `${config.backendUrl}?action=getEmployee&lineId=${userId}&timestamp=${timestamp}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`伺服器回應錯誤: ${response.status}`);
        }
        
        const data = await response.json();
        
        // 驗證回應數據
        if (!data || typeof data !== 'object') {
          throw new Error('無效的伺服器回應格式');
        }
        
        if (data.exists) {
          userName = data.name || '';
          employeeId = data.employeeId || '';
          return true;
        }
        
        return false;
        
      } catch (error) {
        console.error('檢查註冊狀態錯誤:', error);
        throw error;
      }
    }
    
    // 顯示主應用界面
    function showMainApp() {
      document.getElementById('registerContainer').style.display = 'none';
      document.getElementById('mainContainer').style.display = 'block';
      
      // 設置問候語
      const hour = new Date().getHours();
      let greeting = '';
      if (hour < 12) greeting = '早安';
      else if (hour < 18) greeting = '午安';
      else greeting = '晚安';
      
      document.getElementById('greeting').textContent = `${greeting}，${userName || '同仁'}！`;
    }
    
    // 獲取地理位置
    function getLocation() {
      if (!navigator.geolocation) {
        showMessage('locationStatus', '您的瀏覽器不支持定位功能', 'error');
        return;
      }
      
      showMessage('locationStatus', '正在取得定位權限...', 'info');
      
      navigator.geolocation.getCurrentPosition(
        position => {
          currentLocation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy
          };
          
          showMessage('locationStatus', 
            `定位成功！<br><small>精確度: ±${Math.round(currentLocation.accuracy)}公尺</small>`, 
            'success');
            
          document.getElementById('checkInBtn').disabled = false;
          document.getElementById('checkOutBtn').disabled = false;
        },
        error => {
          console.error('獲取位置失敗:', error);
          showMessage('locationStatus', 
            `定位失敗: ${getLocationErrorText(error)}<br>
            <small>請允許定位權限並重新載入頁面</small>`, 
            'error');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }
    
    // 獲取定位錯誤訊息
    function getLocationErrorText(error) {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          return "定位權限被拒絕";
        case error.POSITION_UNAVAILABLE:
          return "定位資訊不可用";
        case error.TIMEOUT:
          return "定位請求超時";
        case error.UNKNOWN_ERROR:
          return "未知定位錯誤";
        default:
          return "無法取得位置";
      }
    }
    
    // 註冊員工
    async function register() {
      const name = document.getElementById('name').value.trim();
      const empId = document.getElementById('employeeId').value.trim();
      
      // 驗證輸入
      if (!name || !empId) {
        showMessage('registerMessage', '請填寫所有欄位', 'error');
        return;
      }
      
      try {
        // 顯示載中狀態
        showMessage('registerMessage', '註冊中，請稍候...', 'info');
        document.getElementById('registerBtn').disabled = true;
        
        // 準備請求數據
        const params = new URLSearchParams({
          action: 'register',
          lineId: userId,
          name: name,
          employeeId: empId,
          timestamp: Date.now()
        });
        
        // 發送註冊請求
        const response = await fetch(config.backendUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: params
        });
        
        // 檢查回應狀態
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`伺服器錯誤: ${response.status} - ${errorText}`);
        }
        
        // 解析回應數據
        const data = await response.json();
        
        // 驗證回應數據
        if (!data || data.status !== 'success') {
          const errorMsg = data?.error || '註冊失敗';
          throw new Error(errorMsg);
        }
        
        // 註冊成功
        showMessage('registerMessage', '註冊成功！正在載入系統...', 'success');
        isRegistered = true;
        userName = data.data?.name || name;
        employeeId = data.data?.employeeId || empId;
        
        // 延遲1.5秒後顯示主界面
        await new Promise(resolve => setTimeout(resolve, 1500));
        showMainApp();
        
      } catch (error) {
        console.error('註冊錯誤:', error);
        
        // 根據錯誤類型顯示相應訊息
        let errorMsg = error.message;
        if (error.message.includes('Failed to fetch')) {
          errorMsg = '無法連接伺服器，請檢查網路連線';
        } else if (error.message.includes('伺服器錯誤')) {
          errorMsg = '伺服器處理請求時發生錯誤';
        }
        
        showMessage('registerMessage', `
          <p><strong>註冊失敗</strong></p>
          <p>${errorMsg}</p>
          <button class="btn-retry" onclick="register()">重試註冊</button>
        `, 'error');
        
      } finally {
        document.getElementById('registerBtn').disabled = false;
      }
    }
    
    // 打卡功能
    async function recordAttendance(type) {
      if (!currentLocation) {
        showMessage('attendanceMessage', '無法取得位置資訊，請重試', 'error');
        return;
      }
      
      try {
        // 顯示載中狀態
        showMessage('attendanceMessage', '打卡中，請稍候...', 'info');
        document.getElementById('checkInBtn').disabled = true;
        document.getElementById('checkOutBtn').disabled = true;
        
        // 準備請求數據
        const params = new URLSearchParams({
          action: type === 'in' ? 'checkIn' : 'checkOut',
          lineId: userId,
          latitude: currentLocation.latitude,
          longitude: currentLocation.longitude,
          timestamp: Date.now()
        });
        
        // 發送打卡請求
        const response = await fetch(config.backendUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: params
        });
        
        // 檢查回應狀態
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`伺服器錯誤: ${response.status} - ${errorText}`);
        }
        
        // 解析回應數據
        const data = await response.json();
        
        // 驗證回應數據
        if (!data || data.status !== 'success') {
          const errorMsg = data?.error || '打卡失敗';
          throw new Error(errorMsg);
        }
        
        // 打卡成功
        const action = type === 'in' ? '上班' : '下班';
        const message = `
          <p><strong>${action}打卡成功！</strong></p>
          <p>時間: ${data.data?.time || '未知'}</p>
          <p>位置: ${data.data?.address || '台北101附近'}</p>
        `;
        
        showMessage('attendanceMessage', message, 'success');
        
      } catch (error) {
        console.error('打卡錯誤:', error);
        
        let errorMsg = error.message;
        if (error.message.includes('Failed to fetch')) {
          errorMsg = '網路錯誤，請檢查您的連線';
        }
        
        showMessage('attendanceMessage', `
          <p><strong>打卡失敗</strong></p>
          <p>${errorMsg}</p>
          <button class="btn-retry" onclick="recordAttendance('${type}')">重試打卡</button>
        `, 'error');
        
      } finally {
        document.getElementById('checkInBtn').disabled = false;
        document.getElementById('checkOutBtn').disabled = false;
      }
    }
    
    // 查詢打卡記錄
    async function queryRecords(date) {
      try {
        // 顯示載中狀態
        const recordsList = document.getElementById('recordsList');
        recordsList.innerHTML = '<div class="info message">查詢中，請稍候...</div>';
        
        // 發送查詢請求
        const response = await fetch(`${config.backendUrl}?action=getAttendance&lineId=${userId}&date=${date}&timestamp=${Date.now()}`);
        
        // 檢查回應狀態
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`伺服器錯誤: ${response.status} - ${errorText}`);
        }
        
        // 解析回應數據
        const data = await response.json();
        
        // 驗證回應數據
        if (!data || !Array.isArray(data.records)) {
          throw new Error('無效的記錄數據格式');
        }
        
        // 顯示查詢結果
        recordsList.innerHTML = '';
        
        if (data.records.length === 0) {
          recordsList.innerHTML = '<div class="info message">沒有找到打卡記錄</div>';
          return;
        }
        
        // 按時間排序
        const sortedRecords = data.records.sort((a, b) => {
          return a.time.localeCompare(b.time);
        });
        
        // 顯示每條記錄
        sortedRecords.forEach(record => {
          const recordDiv = document.createElement('div');
          recordDiv.className = 'record';
          recordDiv.innerHTML = `
            <p><strong>日期:</strong> ${record.date}</p>
            <p><strong>時間:</strong> ${record.time}</p>
            <p><strong>類型:</strong> ${record.type === 'in' ? '上班打卡' : '下班打卡'}</p>
            <p><strong>位置:</strong> ${record.address || '台北101附近'}</p>
          `;
          recordsList.appendChild(recordDiv);
        });
        
      } catch (error) {
        console.error('查詢記錄錯誤:', error);
        document.getElementById('recordsList').innerHTML = `
          <div class="error message">
            <p><strong>查詢失敗</strong></p>
            <p>${error.message || '未知錯誤'}</p>
            <button class="btn-retry" onclick="queryRecords(document.getElementById('recordDate').value)">重試查詢</button>
          </div>
        `;
      }
    }
    
    // 顯示訊息
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.className = `${type} message`;
      element.innerHTML = message;
    }
    
    // 設置事件監聽器
    function setupEventListeners() {
      // 註冊按鈕
      document.getElementById('registerBtn').addEventListener('click', register);
      
      // 打卡按鈕
      document.getElementById('checkInBtn').addEventListener('click', () => recordAttendance('in'));
      document.getElementById('checkOutBtn').addEventListener('click', () => recordAttendance('out'));
      
      // 標籤切換
      document.getElementById('attendanceTab').addEventListener('click', () => {
        document.getElementById('attendanceContent').style.display = 'block';
        document.getElementById('recordsContent').style.display = 'none';
        document.getElementById('attendanceTab').classList.add('active');
        document.getElementById('recordsTab').classList.remove('active');
      });
      
      document.getElementById('recordsTab').addEventListener('click', () => {
        document.getElementById('attendanceContent').style.display = 'none';
        document.getElementById('recordsContent').style.display = 'block';
        document.getElementById('attendanceTab').classList.remove('active');
        document.getElementById('recordsTab').classList.add('active');
        
        // 設置默認日期為今天
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('recordDate').value = today;
        
        // 查詢記錄
        queryRecords(today);
      });
      
      // 查詢按鈕
      document.getElementById('queryBtn').addEventListener('click', () => {
        const date = document.getElementById('recordDate').value;
        queryRecords(date);
      });
    }
    
    // 初始化應用
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      initializeLiff();
    });
  </script>
</body>
</html>
