<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台北101大樓打卡系統</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        .tab {
            display: flex;
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
        }
        .tab button {
            flex: 1;
            padding: 12px;
            background: #ddd;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .tab button.active {
            background: #06c755;
            color: white;
            font-weight: bold;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        button {
            background: #06c755;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .record {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background: white;
        }
        .record p {
            margin: 5px 0;
        }
        .error {
            color: #e74c3c;
            background: #fdecea;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #2ecc71;
            background: #e8f8f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            color: #3498db;
            background: #ebf5fb;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #06c755;
            padding-bottom: 10px;
            margin-top: 0;
        }
        #locationStatus {
            font-weight: bold;
            margin: 15px 0;
        }
        .user-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .distance-info {
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #e3f2fd;
        }
    </style>
</head>
<body>
    <div id="loading">
        <p>系統初始化中...</p>
    </div>

    <!-- 主畫面 (打卡) -->
    <div id="mainContainer" class="container">
        <div class="user-info">
            <p>員工: <span id="userName"></span></p>
            <p>LINE ID: <span id="lineUserId"></span></p>
        </div>

        <div class="tab">
            <button id="checkInTab" class="active">上班打卡</button>
            <button id="checkOutTab">下班打卡</button>
            <button id="recordsTab">打卡記錄</button>
        </div>

        <div id="checkInSection">
            <h2>上班打卡</h2>
            <div id="locationStatus">正在獲取位置資訊...</div>
            <div id="distanceInfo" class="distance-info"></div>
            <button id="checkInBtn">上班打卡</button>
            <div id="checkInResult"></div>
        </div>

        <div id="checkOutSection" style="display: none;">
            <h2>下班打卡</h2>
            <div id="locationStatusOut">正在獲取位置資訊...</div>
            <div id="distanceInfoOut" class="distance-info"></div>
            <button id="checkOutBtn">下班打卡</button>
            <div id="checkOutResult"></div>
        </div>

        <div id="recordsSection" style="display: none;">
            <h2>今日打卡記錄</h2>
            <div id="todayRecords"></div>
            <button id="refreshRecordsBtn">刷新記錄</button>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // 全局變量
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbx5I9vg9m7nTmkb0qrU8gMGXeguzVJ__ALYnqZPLdxTXTbmQr0x4voXcS_l1HpqCsw/exec'; // 替換為您的Google Apps Script部署URL
        let userId = '';
        let displayName = '';
        let currentTab = 'checkIn';

        // DOM元素
        const loadingDiv = document.getElementById('loading');
        const mainContainer = document.getElementById('mainContainer');
        const userNameSpan = document.getElementById('userName');
        const lineUserIdSpan = document.getElementById('lineUserId');
        const locationStatusDiv = document.getElementById('locationStatus');
        const locationStatusOutDiv = document.getElementById('locationStatusOut');
        const distanceInfoDiv = document.getElementById('distanceInfo');
        const distanceInfoOutDiv = document.getElementById('distanceInfoOut');
        const checkInBtn = document.getElementById('checkInBtn');
        const checkOutBtn = document.getElementById('checkOutBtn');
        const checkInResultDiv = document.getElementById('checkInResult');
        const checkOutResultDiv = document.getElementById('checkOutResult');
        const todayRecordsDiv = document.getElementById('todayRecords');
        const refreshRecordsBtn = document.getElementById('refreshRecordsBtn');
        const checkInTab = document.getElementById('checkInTab');
        const checkOutTab = document.getElementById('checkOutTab');
        const recordsTab = document.getElementById('recordsTab');
        const checkInSection = document.getElementById('checkInSection');
        const checkOutSection = document.getElementById('checkOutSection');
        const recordsSection = document.getElementById('recordsSection');

        // 初始化LIFF
// 在 initializeLiff 函數中添加更詳細的錯誤處理
async function initializeLiff() {
    try {
        await liff.init({ liffId: '2007700262-da76ZbYE' });
        
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }
        
        const profile = await liff.getProfile();
        userId = profile.userId;
        displayName = profile.displayName;
        
        userNameSpan.textContent = displayName;
        lineUserIdSpan.textContent = userId;
        
        // 添加重試機制
        let retries = 3;
        while (retries > 0) {
            try {
                await registerOrCheckUser();
                break;
            } catch (error) {
                retries--;
                if (retries === 0) throw error;
                await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒後重試
            }
        }
        
        loadingDiv.style.display = 'none';
        mainContainer.style.display = 'block';
        updateLocation();
        loadTodayRecords();
        
    } catch (error) {
        console.error('完整錯誤日誌:', {
            timestamp: new Date(),
            userId,
            error: error.stack || error.message,
            LIFFStatus: liff ? liff.isLoggedIn() : 'LIFF未初始化'
        });
        
        showError(loadingDiv, `系統初始化失敗，請稍後再試。錯誤代碼: ${error.message}`);
        
        // 提供重試按鈕
        loadingDiv.innerHTML = `
            <div class="error">
                <p>系統初始化失敗: ${error.message}</p>
                <button onclick="window.location.reload()" style="padding: 10px; margin-top: 10px;">重新載入</button>
                <p>若問題持續，請聯繫管理員</p>
            </div>
        `;
    }
}

        // 註冊或檢查用戶
// 修改 initializeLiff 函數中的 registerOrCheckUser 部分
async function registerOrCheckUser() {
    try {
        showLoading(loadingDiv, '檢查用戶狀態...');
        
        const formData = new URLSearchParams();
        formData.append('action', 'registerOrCheck');
        formData.append('lineUserId', userId);
        formData.append('name', displayName);
        
        // 改用 try-catch 包裝 fetch 並添加錯誤細節
        let response;
        try {
            response = await fetch(scriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });
            
            if (!response.ok) {
                // 嘗試獲取後端返回的錯誤訊息
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP錯誤! 狀態碼: ${response.status}`);
            }
            
            return await response.json();
            
        } catch (fetchError) {
            console.error('Fetch錯誤詳情:', {
                error: fetchError,
                request: {
                    url: scriptUrl,
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString()
                }
            });
            throw new Error(`網絡請求失敗: ${fetchError.message}`);
        }
        
    } catch (error) {
        console.error('用戶狀態檢查失敗:', error);
        throw error; // 重新拋出錯誤以便外層處理
    }
}

        // 更新位置資訊
        async function updateLocation() {
            try {
                if (!navigator.geolocation) {
                    throw new Error('您的瀏覽器不支持地理位置功能');
                }
                
                const position = await getLocation();
                const { latitude, longitude, accuracy } = position.coords;
                
                // 計算與台北101的距離 (緯度: 25.0330, 經度: 121.5654)
                const distance = calculateDistance(
                    latitude, 
                    longitude, 
                    25.0330, 
                    121.5654
                );
                
                const locationText = `緯度: ${latitude.toFixed(6)}, 經度: ${longitude.toFixed(6)} (精確度: ±${accuracy.toFixed(1)} 公尺)`;
                const distanceText = distance <= 300 ? 
                    `您目前在台北101大樓內 (距離: ${distance.toFixed(0)} 公尺)` :
                    `您不在台北101大樓內 (距離: ${distance.toFixed(0)} 公尺)`;
                
                const locationElement = currentTab === 'checkIn' ? locationStatusDiv : locationStatusOutDiv;
                const distanceElement = currentTab === 'checkIn' ? distanceInfoDiv : distanceInfoOutDiv;
                
                locationElement.innerHTML = locationText;
                distanceElement.innerHTML = distanceText;
                
                if (distance > 300) {
                    distanceElement.style.backgroundColor = '#ffebee';
                    distanceElement.style.color = '#c62828';
                } else {
                    distanceElement.style.backgroundColor = '#e8f5e9';
                    distanceElement.style.color = '#2e7d32';
                }
                
                return { latitude, longitude, distance };
                
            } catch (error) {
                console.error('獲取位置失敗:', error);
                const locationElement = currentTab === 'checkIn' ? locationStatusDiv : locationStatusOutDiv;
                locationElement.innerHTML = `位置獲取失敗: ${error.message}`;
                locationElement.style.color = '#c62828';
                
                const distanceElement = currentTab === 'checkIn' ? distanceInfoDiv : distanceInfoOutDiv;
                distanceElement.innerHTML = '無法計算距離';
                distanceElement.style.backgroundColor = '#ffebee';
                distanceElement.style.color = '#c62828';
                
                throw error;
            }
        }

        // 獲取位置
        function getLocation() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    resolve,
                    error => {
                        let errorMessage = '獲取位置失敗: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += '用戶拒絕了位置請求';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += '位置資訊不可用';
                                break;
                            case error.TIMEOUT:
                                errorMessage += '獲取位置超時';
                                break;
                            default:
                                errorMessage += '未知錯誤';
                        }
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // 計算兩個座標之間的距離 (單位: 公尺)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // 地球半徑 (公尺)
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // 上班打卡
        checkInBtn.addEventListener('click', async () => {
            await handleCheckInOut('checkIn');
        });

        // 下班打卡
        checkOutBtn.addEventListener('click', async () => {
            await handleCheckInOut('checkOut');
        });

        // 處理打卡
        async function handleCheckInOut(type) {
            const resultDiv = type === 'checkIn' ? checkInResultDiv : checkOutResultDiv;
            const button = type === 'checkIn' ? checkInBtn : checkOutBtn;
            
            try {
                showLoading(button, '處理中...');
                
                // 獲取位置
                const location = await updateLocation();
                
                // 檢查是否在台北101範圍內 (300公尺內)
                if (location.distance > 300) {
                    throw new Error('您不在台北101大樓內，無法打卡');
                }
                
                // 發送打卡請求
                const formData = new URLSearchParams();
                formData.append('action', type === 'checkIn' ? 'checkIn' : 'checkOut');
                formData.append('lineUserId', userId);
                formData.append('latitude', location.latitude);
                formData.append('longitude', location.longitude);
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || '打卡失敗');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(resultDiv, `${type === 'checkIn' ? '上班' : '下班'}打卡成功！`);
                    
                    // 刷新記錄
                    loadTodayRecords();
                    
                    // 發送LINE通知
                    if (liff.isInClient()) {
                        try {
                            await liff.sendMessages([
                                {
                                    type: 'text',
                                    text: `✅ ${type === 'checkIn' ? '上班' : '下班'}打卡成功\n姓名: ${displayName}\n時間: ${new Date().toLocaleString('zh-TW')}\n位置: 台北101大樓`
                                }
                            ]);
                        } catch (err) {
                            console.error('發送訊息失敗:', err);
                        }
                    }
                } else {
                    throw new Error(data.message || '打卡失敗');
                }
                
            } catch (error) {
                console.error('打卡失敗:', error);
                showError(resultDiv, `打卡失敗: ${error.message}`);
            } finally {
                button.innerHTML = type === 'checkIn' ? '上班打卡' : '下班打卡';
            }
        }

        // 載入今日打卡記錄
        async function loadTodayRecords() {
            try {
                todayRecordsDiv.innerHTML = '<p>載入中...</p>';
                
                const response = await fetch(`${scriptUrl}?action=getTodayRecords&lineUserId=${userId}`);
                
                if (!response.ok) {
                    throw new Error('無法獲取打卡記錄');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.records.length === 0) {
                        todayRecordsDiv.innerHTML = '<p>今日尚無打卡記錄</p>';
                    } else {
                        let html = '';
                        data.records.forEach(record => {
                            html += `
                                <div class="record">
                                    <p><strong>類型:</strong> ${record.type === 'checkIn' ? '上班' : '下班'}</p>
                                    <p><strong>日期:</strong> ${record.date}</p>
                                    <p><strong>時間:</strong> ${record.time}</p>
                                    <p><strong>位置:</strong> ${record.address || '台北101大樓'}</p>
                                </div>
                            `;
                        });
                        todayRecordsDiv.innerHTML = html;
                    }
                } else {
                    throw new Error(data.message || '獲取記錄失敗');
                }
                
            } catch (error) {
                console.error('載入記錄失敗:', error);
                todayRecordsDiv.innerHTML = `<div class="error">載入記錄失敗: ${error.message}</div>`;
            }
        }

        // 刷新記錄
        refreshRecordsBtn.addEventListener('click', loadTodayRecords);

        // 切換標籤頁
        checkInTab.addEventListener('click', () => switchTab('checkIn'));
        checkOutTab.addEventListener('click', () => switchTab('checkOut'));
        recordsTab.addEventListener('click', () => switchTab('records'));

        function switchTab(tab) {
            currentTab = tab;
            
            // 更新標籤按鈕樣式
            checkInTab.classList.remove('active');
            checkOutTab.classList.remove('active');
            recordsTab.classList.remove('active');
            
            // 隱藏所有內容區
            checkInSection.style.display = 'none';
            checkOutSection.style.display = 'none';
            recordsSection.style.display = 'none';
            
            // 顯示選中的內容區
            if (tab === 'checkIn') {
                checkInTab.classList.add('active');
                checkInSection.style.display = 'block';
                updateLocation();
            } else if (tab === 'checkOut') {
                checkOutTab.classList.add('active');
                checkOutSection.style.display = 'block';
                updateLocation();
            } else {
                recordsTab.classList.add('active');
                recordsSection.style.display = 'block';
                loadTodayRecords();
            }
        }

        // 顯示加載狀態
        function showLoading(element, message) {
            if (element.tagName === 'BUTTON') {
                element.innerHTML = `<span class="loading"></span> ${message}`;
            } else {
                element.innerHTML = `<div class="info"><span class="loading"></span> ${message}</div>`;
            }
        }

        // 顯示成功訊息
        function showSuccess(element, message) {
            element.innerHTML = `<div class="success">${message}</div>`;
        }

        // 顯示錯誤訊息
        function showError(element, message) {
            element.innerHTML = `<div class="error">${message}</div>`;
        }

        // 初始化應用
        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();
        });
    </script>
</body>
</html>
