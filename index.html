<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台北101打卡系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #loading {
      text-align: center;
      padding: 20px;
      font-size: 18px;
    }
    .tab {
      display: flex;
      margin-bottom: 20px;
      border-radius: 5px;
      overflow: hidden;
    }
    .tab button {
      flex: 1;
      padding: 12px;
      background: #ddd;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    .tab button.active {
      background: #06c755;
      color: white;
      font-weight: bold;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, button {
      width: 100%;
      padding: 12px;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 16px;
    }
    button {
      background: #06c755;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .record {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      background: white;
    }
    .record p {
      margin: 5px 0;
    }
    .error {
      color: #e74c3c;
      background: #fdecea;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success {
      color: #2ecc71;
      background: #e8f8f0;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .info {
      color: #3498db;
      background: #ebf5fb;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #06c755;
      padding-bottom: 10px;
      margin-top: 0;
    }
    #locationStatus {
      font-weight: bold;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div id="loading">
    <p>系統載入中，請稍候...</p>
  </div>
  
  <div id="registerContainer" class="container">
    <h2>員工註冊</h2>
    <div class="form-group">
      <label for="name">姓名</label>
      <input type="text" id="name" placeholder="請輸入您的姓名" required>
    </div>
    <div class="form-group">
      <label for="employeeId">識別證卡號</label>
      <input type="text" id="employeeId" placeholder="請輸入您的員工編號" required>
    </div>
    <button id="registerBtn">註冊</button>
    <div id="registerMessage"></div>
  </div>

  
  <div id="mainContainer" class="container">
    <div class="tab">
      <button id="attendanceTab" class="active">打卡</button>
      <button id="recordsTab">查詢記錄</button>
    </div>
    
    <div id="attendanceContent">
      <h2 id="greeting"></h2>
      <div id="locationStatus" class="info">正在取得定位資訊...</div>
      <button id="checkInBtn" disabled>上班打卡</button>
      <button id="checkOutBtn" disabled>下班打卡</button>
      <div id="attendanceMessage"></div>
    </div>
    
    <div id="recordsContent" style="display: none;">
      <h2>打卡記錄查詢</h2>
      <div class="form-group">
        <label for="recordDate">查詢日期</label>
        <input type="date" id="recordDate">
      </div>
      <button id="queryBtn">查詢</button>
      <div id="recordsList"></div>
    </div>
  </div>

  <script>
    // 配置常數
    const CONFIG = {
      spreadsheetId: '1b2iK29LHm8laXr8KPf4BrSrInHgxz5tQIWL8PPfGPI0',
      geocodingApiKey: 'AIzaSyAwYrQnsfuYfRJ1sGLLIcubLJ4pBD9HW9g',
      sheetsApiKey: 'AIzaSyAwYrQnsfuYfRJ1sGLLIcubLJ4pBD9HW9g',
      taipei101: {
        latitude: 25.0330,
        longitude: 121.5654,
        allowedRadius: 200 // 調整為200公尺範圍
      },
      sheets: {
        employees: 'employees',
        attendance: 'attendance'
      }
    };


    // 全局變量
    let userId = null;
    let isRegistered = false;
    let currentLocation = null;
    let userName = '';
    let employeeId = '';
    let gapiInitialized = false;


    // 新增：純JavaScript的日期格式化函數
    function formatDate(date, format) {
      const pad = (num) => num.toString().padStart(2, '0');
      const taiwanOffset = 8 * 60 * 60 * 1000; // 台灣時區UTC+8
      const localDate = new Date(date.getTime() + taiwanOffset);
      
      return format
        .replace('yyyy', localDate.getUTCFullYear())
        .replace('MM', pad(localDate.getUTCMonth() + 1))
        .replace('dd', pad(localDate.getUTCDate()))
        .replace('HH', pad(localDate.getUTCHours()))
        .replace('mm', pad(localDate.getUTCMinutes()))
        .replace('ss', pad(localDate.getUTCSeconds()));
    }

    // 初始化 LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: '2007700262-da76ZbYE' });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        const profile = await liff.getProfile();
        userId = profile.userId;
        
        // 初始化 Google API
        await initGoogleAPI();
        
        // 檢查是否已註冊
        await checkRegistration();
        
        document.getElementById('loading').style.display = 'none';
        if (isRegistered) {
          showMainApp();
        } else {
          document.getElementById('registerContainer').style.display = 'block';
        }
        
        // 獲取位置
        getLocation();
        
        // 初始化事件監聽器
        setupEventListeners();
      } catch (error) {
        console.error('初始化失敗:', error);
        document.getElementById('loading').innerHTML = 
          '<div class="error">系統初始化失敗，請重新載入或稍後再試</div>';
      }
    }

    // 初始化 Google API
    function initGoogleAPI() {
      return new Promise((resolve, reject) => {
        gapi.load('client', () => {
          gapi.client.init({
            apiKey: CONFIG.sheetsApiKey,
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
          }).then(() => {
            gapiInitialized = true;
            resolve();
          }).catch(error => {
            console.error('Google API 初始化失敗:', error);
            reject(error);
          });
        });
      });
    }

    // 檢查是否已註冊
    async function checkRegistration() {
      try {
        if (!gapiInitialized) await initGoogleAPI();
        
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: CONFIG.spreadsheetId,
          range: `${CONFIG.sheets.employees}!A2:D`
        });
        
        const employees = response.result.values || [];
        const existingEmployee = employees.find(row => row[0] === userId);
        
        if (existingEmployee) {
          isRegistered = true;
          userName = existingEmployee[1];
          employeeId = existingEmployee[2];
          return true;
        }
        return false;
      } catch (error) {
        console.error('檢查註冊失敗:', error);
        return false;
      }
    }

    // 顯示主應用
    function showMainApp() {
      document.getElementById('registerContainer').style.display = 'none';
      document.getElementById('mainContainer').style.display = 'block';
      
      // 設置當前時間問候語
      const hour = new Date().getHours();
      let greeting = '';
      if (hour < 12) greeting = '早安';
      else if (hour < 18) greeting = '午安';
      else greeting = '晚安';
      
      document.getElementById('greeting').textContent = `${greeting}，${userName} (${employeeId})！`;
    }

    // 獲取地理位置
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            currentLocation = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            };
            document.getElementById('locationStatus').className = 'success';
            document.getElementById('locationStatus').innerHTML = 
              '定位成功！您現在可以打卡<br><small>此系統僅限台北101大樓附近使用</small>';
            document.getElementById('checkInBtn').disabled = false;
            document.getElementById('checkOutBtn').disabled = false;
          },
          error => {
            console.error('獲取位置失敗:', error);
            document.getElementById('locationStatus').className = 'error';
            document.getElementById('locationStatus').textContent = 
              '定位失敗: ' + getErrorMessage(error);
            document.getElementById('checkInBtn').disabled = true;
            document.getElementById('checkOutBtn').disabled = true;
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      } else {
        document.getElementById('locationStatus').className = 'error';
        document.getElementById('locationStatus').textContent = 
          '您的瀏覽器不支持定位功能';
      }
    }

    // 獲取定位錯誤訊息
    function getErrorMessage(error) {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          return "您拒絕了定位請求，請允許定位權限";
        case error.POSITION_UNAVAILABLE:
          return "定位資訊不可用";
        case error.TIMEOUT:
          return "獲取位置超時，請重試";
        case error.UNKNOWN_ERROR:
          return "發生未知錯誤";
        default:
          return error.message;
      }
    }

    // 註冊事件監聽器
    function setupEventListeners() {
      // 註冊按鈕
      document.getElementById('registerBtn').addEventListener('click', register);
      
      // 打卡按鈕
      document.getElementById('checkInBtn').addEventListener('click', () => recordAttendance('in'));
      document.getElementById('checkOutBtn').addEventListener('click', () => recordAttendance('out'));
      
      // 標籤切換
      document.getElementById('attendanceTab').addEventListener('click', () => {
        document.getElementById('attendanceContent').style.display = 'block';
        document.getElementById('recordsContent').style.display = 'none';
        document.getElementById('attendanceTab').classList.add('active');
        document.getElementById('recordsTab').classList.remove('active');
      });
      
      document.getElementById('recordsTab').addEventListener('click', () => {
        document.getElementById('attendanceContent').style.display = 'none';
        document.getElementById('recordsContent').style.display = 'block';
        document.getElementById('attendanceTab').classList.remove('active');
        document.getElementById('recordsTab').classList.add('active');
        // 設置默認日期為今天
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('recordDate').value = today;
        // 查詢記錄
        queryRecords(today);
      });
      
      // 查詢按鈕
      document.getElementById('queryBtn').addEventListener('click', () => {
        const date = document.getElementById('recordDate').value;
        queryRecords(date);
      });
    }

   // 修改後的register函數
    async function register() {
      const name = document.getElementById('name').value.trim();
      const empId = document.getElementById('employeeId').value.trim();
      
      if (!name || !empId) {
        showMessage('registerMessage', '請填寫所有欄位', 'error');
        return;
      }
      
      try {
        if (!gapiInitialized) await initGoogleAPI();
        
        // 檢查是否已註冊
        const checkResponse = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: CONFIG.spreadsheetId,
          range: `${CONFIG.sheets.employees}!A2:D`
        });
        
        const employees = checkResponse.result.values || [];
        const existingEmployee = employees.find(row => row[0] === userId || row[2] === empId);
        
        if (existingEmployee) {
          showMessage('registerMessage', '員工已註冊', 'error');
          return;
        }
        
        showMessage('registerMessage', '註冊中，請稍候...', 'info');
        
        // 使用新的formatDate函數
        const now = new Date();
        const registerDate = formatDate(now, "yyyy-MM-dd");
        
        // 添加新員工
        const response = await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: CONFIG.spreadsheetId,
          range: `${CONFIG.sheets.employees}!A1:D1`,
          valueInputOption: 'USER_ENTERED',
          resource: {
            values: [[userId, name, empId, registerDate]]
          }
        });
        
        if (response.status === 200) {
          isRegistered = true;
          userName = name;
          employeeId = empId;
          showMainApp();
          
          // 註冊成功後顯示歡迎訊息
          const hour = now.getHours();
          let greeting = '';
          if (hour < 12) greeting = '早安';
          else if (hour < 18) greeting = '午安';
          else greeting = '晚安';
          
          showMessage('attendanceMessage', `${greeting}，${name}！註冊成功，現在可以開始打卡`, 'success');
        } else {
          showMessage('registerMessage', '註冊失敗，請稍後再試', 'error');
        }
      } catch (error) {
        console.error('註冊錯誤:', error);
        showMessage('registerMessage', '註冊失敗: ' + error.message, 'error');
      }
    }


    // 打卡
    async function recordAttendance(type) {
      if (!currentLocation) {
        showMessage('attendanceMessage', '無法獲取位置信息', 'error');
        return;
      }
      
      try {
        if (!gapiInitialized) await initGoogleAPI();
        
        // 計算與台北101的距離
        const distance = calculateDistance(
          currentLocation.latitude,
          currentLocation.longitude,
          CONFIG.taipei101.latitude,
          CONFIG.taipei101.longitude
        );
        
        // 檢查是否在允許範圍內
        if (distance > CONFIG.taipei101.allowedRadius) {
          showMessage('attendanceMessage', `距離台北101大樓${Math.round(distance)}公尺，超出允許範圍（${CONFIG.taipei101.allowedRadius}公尺）`, 'error');
          return;
        }
        
      // 替換原有的日期處理
      const now = new Date();
      const dateStr = formatDate(now, "yyyy-MM-dd");
      const timeStr = formatDate(now, "HH:mm:ss");

        
        // 檢查是否已打卡
        const checkResponse = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: CONFIG.spreadsheetId,
          range: `${CONFIG.sheets.attendance}!A2:G`
        });
        
        const records = checkResponse.result.values || [];
        const todayRecords = records.filter(row => 
          row[0] === userId && row[1] === dateStr && row[3] === type
        );
        
        if (todayRecords.length > 0) {
          showMessage('attendanceMessage', `今日已${type === 'in' ? '上班打卡' : '下班打卡'}`, 'error');
          return;
        }
        
        // 使用Geocoding API獲取地址
        const address = await getAddressFromCoordinates(currentLocation.latitude, currentLocation.longitude);
        
        showMessage('attendanceMessage', '打卡中，請稍候...', 'info');
        
        // 記錄打卡
        const response = await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: CONFIG.spreadsheetId,
          range: `${CONFIG.sheets.attendance}!A1:G1`,
          valueInputOption: 'USER_ENTERED',
          resource: {
            values: [[
              userId, 
              dateStr, 
              timeStr, 
              type, 
              currentLocation.latitude, 
              currentLocation.longitude, 
              address || `台北101大樓範圍內 (${Math.round(distance)}公尺)`
            ]]
          }
        });
        
        if (response.status === 200) {
          const action = type === 'in' ? '上班' : '下班';
          const message = `
            <strong>${action}打卡成功！</strong>
            <p>時間: ${timeStr}</p>
            <p>距離台北101: ${Math.round(distance)}公尺</p>
            <p>位置: ${address || `台北101大樓範圍內 (${Math.round(distance)}公尺)`}</p>
          `;
          showMessage('attendanceMessage', message, 'success');
        } else {
          showMessage('attendanceMessage', '打卡失敗', 'error');
        }
      } catch (error) {
        console.error('打卡錯誤:', error);
        showMessage('attendanceMessage', '打卡失敗: ' + error.message, 'error');
      }
    }

    // 查詢打卡記錄
    async function queryRecords(date) {
      try {
        if (!gapiInitialized) await initGoogleAPI();
        
        document.getElementById('recordsList').innerHTML = '<p>查詢中...</p>';
        
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: CONFIG.spreadsheetId,
          range: `${CONFIG.sheets.attendance}!A2:G`
        });
        
        const recordsList = document.getElementById('recordsList');
        recordsList.innerHTML = '';
        
        const allRecords = response.result.values || [];
        let filteredRecords = allRecords.filter(row => row[0] === userId);
        
        if (date) {
          filteredRecords = filteredRecords.filter(row => row[1] === date);
        }
        
        if (filteredRecords.length > 0) {
          // 按時間排序
          const sortedRecords = filteredRecords.sort((a, b) => {
            return a[2].localeCompare(b[2]);
          });
          
          sortedRecords.forEach(record => {
            const recordDiv = document.createElement('div');
            recordDiv.className = 'record';
            recordDiv.innerHTML = `
              <p><strong>日期:</strong> ${record[1]}</p>
              <p><strong>時間:</strong> ${record[2]}</p>
              <p><strong>類型:</strong> ${record[3] === 'in' ? '上班打卡' : '下班打卡'}</p>
              <p><strong>位置:</strong> ${record[6]}</p>
            `;
            recordsList.appendChild(recordDiv);
          });
        } else {
          recordsList.innerHTML = '<div class="info">沒有找到記錄</div>';
        }
      } catch (error) {
        console.error('查詢記錄失敗:', error);
        document.getElementById('recordsList').innerHTML = 
          '<div class="error">查詢記錄失敗，請稍後再試</div>';
      }
    }

    // 使用Geocoding API獲取地址
    async function getAddressFromCoordinates(latitude, longitude) {
      try {
        const response = await fetch(
          `https://maps.googleapis.com/maps/api/geocode/json?latlng=${latitude},${longitude}&key=${CONFIG.geocodingApiKey}&language=zh-TW`
        );
        
        if (!response.ok) {
          throw new Error('Geocoding API請求失敗');
        }
        
        const data = await response.json();
        
        if (data.status === 'OK' && data.results.length > 0) {
          return data.results[0].formatted_address;
        }
        return null;
      } catch (error) {
        console.error('Geocoding API錯誤:', error);
        return null;
      }
    }

    // 計算兩點間距離(公尺)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // 地球半徑(公尺)
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    // 格式化日期
    function formatDate(date, format) {
      const pad = num => num.toString().padStart(2, '0');
      
      return format
        .replace('yyyy', date.getFullYear())
        .replace('MM', pad(date.getMonth() + 1))
        .replace('dd', pad(date.getDate()))
        .replace('HH', pad(date.getHours()))
        .replace('mm', pad(date.getMinutes()))
        .replace('ss', pad(date.getSeconds()));
    }

    // 顯示消息
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = message;
      element.className = type;
    }

    // 初始化應用
    document.addEventListener('DOMContentLoaded', () => {
      initializeLiff();
    });
  </script>
</body>
</html>
