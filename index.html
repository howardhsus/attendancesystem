<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台北101 | 員工打卡系統</title>
    <style>
        /* 保持原有的樣式不變 */
    </style>
</head>
<body>
    <!-- 保持原有的HTML結構不變 -->

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // 配置設定
        const CONFIG = {
            SCRIPT_ID: 'AKfycbzp9Uv-dygOmSeh4cZAYTntOJSwni6yG3fccJbLTsb2J9Ft8GVReWepVRt2uVAE52m3bw',
            LIFF_ID: '2007700262-da76ZbYE',
            API_TIMEOUT: 15000,
            DEBUG_MODE: true
        };

        // 狀態管理 - 修正版
        const appState = {
            userId: null,
            profile: null,
            debugLog: [],
            elements: null,
            
            // 初始化方法
            init: function() {
                this.elements = {
                    loading: document.getElementById('loading'),
                    statusMessage: document.getElementById('statusMessage'),
                    unregisteredContainer: document.getElementById('unregisteredContainer'),
                    registeredContainer: document.getElementById('registeredContainer'),
                    userIdDisplay: document.getElementById('userIdDisplay'),
                    employeeName: document.getElementById('employeeName'),
                    employeeId: document.getElementById('employeeId'),
                    copyButton: document.getElementById('copyButton'),
                    retryButton: document.getElementById('retryButton'),
                    startWorkBtn: document.getElementById('startWorkBtn'),
                    debugInfo: document.getElementById('debugInfo'),
                    forceContinue: document.getElementById('forceContinue')
                };
                
                // 綁定事件
                if (this.elements.copyButton) {
                    this.elements.copyButton.addEventListener('click', () => this.copyUserId());
                }
                if (this.elements.retryButton) {
                    this.elements.retryButton.addEventListener('click', () => this.retryCheck());
                }
                if (this.elements.forceContinue) {
                    this.elements.forceContinue.addEventListener('click', () => this.forceContinue());
                }
                if (this.elements.startWorkBtn) {
                    this.elements.startWorkBtn.addEventListener('click', () => this.startWork());
                }
            },
            
            // 複製用戶ID
            copyUserId: function() {
                navigator.clipboard.writeText(this.userId).then(() => {
                    alert('已複製用戶ID到剪貼簿');
                }).catch(err => {
                    console.error('複製失敗:', err);
                    alert('複製失敗，請手動複製');
                });
            },
            
            // 重新檢查
            retryCheck: function() {
                this.showLoading();
                initializeApp();
            },
            
            // 強制繼續
            forceContinue: function() {
                this.logDebug('用戶手動跳過檢查');
                if (this.profile?.userId) {
                    this.showUnregistered(this.profile.userId);
                } else {
                    this.showUnregistered('無法取得用戶ID');
                }
            },
            
            // 開始工作
            startWork: function() {
                alert('打卡功能將在此實現');
            },
            
            // 顯示載入狀態
            showLoading: function() {
                this.elements.loading.classList.remove('hidden');
                this.elements.unregisteredContainer.classList.add('hidden');
                this.elements.registeredContainer.classList.add('hidden');
            },
            
            // 顯示未註冊狀態 - 修正版
            showUnregistered: function(userId) {
                this.userId = userId;
                if (this.elements.userIdDisplay) {
                    this.elements.userIdDisplay.textContent = userId;
                }
                this.elements.loading.classList.add('hidden');
                this.elements.unregisteredContainer.classList.remove('hidden');
                this.elements.registeredContainer.classList.add('hidden');
            },
            
            // 顯示已註冊狀態 - 修正版
            showRegistered: function(userData) {
                if (this.elements.employeeName) {
                    this.elements.employeeName.textContent = userData.name || '未提供';
                }
                if (this.elements.employeeId) {
                    this.elements.employeeId.textContent = userData.empId || '未提供';
                }
                this.elements.loading.classList.add('hidden');
                this.elements.unregisteredContainer.classList.add('hidden');
                this.elements.registeredContainer.classList.remove('hidden');
            },
            
            // 記錄除錯資訊
            logDebug: function(message) {
                if (!CONFIG.DEBUG_MODE) return;
                
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}`;
                this.debugLog.push(logEntry);
                
                if (this.elements.debugInfo) {
                    this.elements.debugInfo.textContent = this.debugLog.join('\n');
                    this.elements.debugInfo.scrollTop = this.elements.debugInfo.scrollHeight;
                }
                
                // 確保除錯面板可見
                if (CONFIG.DEBUG_MODE && this.elements.debugInfo) {
                    this.elements.debugInfo.classList.remove('hidden');
                }
            }
        };

        // 更新狀態訊息
        function updateStatus(message) {
            if (appState.elements.statusMessage) {
                appState.elements.statusMessage.innerHTML = `
                    <span class="loading"></span>
                    <span>${message}</span>
                `;
            }
            appState.logDebug(message);
        }

        // 強化版註冊檢查
        async function checkUserRegistration(userId) {
            try {
                updateStatus('正在驗證員工資格...');
                appState.logDebug(`開始註冊檢查: ${userId}`);
                
                // 正規化用戶ID
                const normalizedUserId = userId.trim().toLowerCase();
                appState.logDebug(`正規化後用戶ID: ${normalizedUserId}`);
                
                const url = new URL(`https://script.google.com/macros/s/${CONFIG.SCRIPT_ID}/exec`);
                url.searchParams.append('action', 'checkRegistration');
                url.searchParams.append('userId', normalizedUserId);
                url.searchParams.append('t', Date.now());
                
                appState.logDebug(`API請求: ${url.toString()}`);
                
                // 添加超時控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.API_TIMEOUT);
                
                const response = await fetch(url, {
                    method: 'GET',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                appState.logDebug(`回應狀態: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`伺服器錯誤: ${response.status}`);
                }
                
                const data = await response.json();
                appState.logDebug(`API回應: ${JSON.stringify(data)}`);
                
                if (!data.success) {
                    throw new Error(data.error || '註冊檢查失敗');
                }
                
                return data;
            } catch (error) {
                appState.logDebug(`嚴格檢查失敗: ${error.message}`);
                
                // 超時時顯示強制繼續按鈕
                if (error.name === 'AbortError' && appState.elements.forceContinue) {
                    appState.elements.forceContinue.classList.remove('hidden');
                    updateStatus('伺服器回應超時，請稍後重試');
                    throw new Error('API請求超時');
                }
                
                throw error;
            }
        }

        // 主初始化函數
        async function initializeApp() {
            try {
                // 初始化狀態管理
                appState.init();
                updateStatus('正在啟動LINE環境...');
                
                // 初始化LIFF（10秒超時）
                const liffInitPromise = liff.init({ liffId: CONFIG.LIFF_ID });
                const liffTimeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('LIFF初始化超時')), 10000)
                );
                
                await Promise.race([liffInitPromise, liffTimeout]);
                appState.logDebug('LIFF初始化完成');
                
                if (!liff.isLoggedIn()) {
                    updateStatus('導向LINE登入頁面...');
                    liff.login();
                    return;
                }
                
                updateStatus('獲取用戶資訊中...');
                const profile = await liff.getProfile();
                appState.logDebug(`用戶原始ID: ${profile.userId}`);
                appState.profile = profile;
                
                updateStatus('驗證員工資料中...');
                const result = await checkUserRegistration(profile.userId);
                
                if (result.registered) {
                    updateStatus('驗證成功！');
                    appState.showRegistered({
                        name: result.data.name,
                        empId: result.data.empId
                    });
                } else {
                    appState.showUnregistered(profile.userId);
                }
            } catch (error) {
                appState.logDebug(`初始化失敗: ${error.message}`);
                updateStatus(`系統錯誤: ${error.message}`);
                
                // 顯示強制繼續按鈕
                if (appState.elements.forceContinue) {
                    appState.elements.forceContinue.classList.remove('hidden');
                }
                
                // 如果有用戶ID但檢查失敗，顯示未註冊畫面
                if (appState.profile?.userId) {
                    appState.logDebug('使用緩存用戶ID顯示未註冊畫面');
                    appState.showUnregistered(appState.profile.userId);
                }
            }
        }

        // 啟動應用
        document.addEventListener('DOMContentLoaded', () => {
            // 先顯示除錯模式狀態
            appState.logDebug('除錯模式已啟用');
            initializeApp().catch(error => {
                appState.logDebug(`啟動失敗: ${error.message}`);
            });
        });
    </script>
</body>
</html>
