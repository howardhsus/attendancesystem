<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台北101打卡系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root {
      --primary-color: #06C755;
      --error-color: #E74C3C;
      --success-color: #2ECC71;
      --info-color: #3498DB;
      --text-color: #333333;
      --border-color: #DDDDDD;
      --bg-color: #F5F5F5;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
      max-width: 100%;
      min-height: 100vh;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .container {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    
    #loading {
      text-align: center;
      padding: 40px 20px;
      font-size: 18px;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary-color);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-container {
      background-color: #FDECEA;
      border: 1px solid var(--error-color);
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .error-container h3 {
      color: var(--error-color);
      margin-bottom: 10px;
    }
    
    .debug-info {
      background-color: #F8F9FA;
      border-left: 4px solid var(--info-color);
      padding: 10px;
      margin: 15px 0;
      font-size: 14px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .retry-btn, .feedback-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .retry-btn {
      background-color: var(--primary-color);
      color: white;
    }
    
    .feedback-btn {
      background-color: var(--info-color);
      color: white;
    }
    
    h1, h2 {
      color: var(--text-color);
      margin-bottom: 20px;
    }
    
    h1 {
      font-size: 24px;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 10px;
    }
    
    h2 {
      font-size: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
    }
    
    .tab {
      display: flex;
      margin-bottom: 20px;
      border-radius: 5px;
      overflow: hidden;
      background-color: #F0F0F0;
    }
    
    .tab button {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .tab button.active {
      background: var(--primary-color);
      color: white;
      font-weight: bold;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 15px;
    }
    
    input, select {
      width: 100%;
      padding: 12px 15px;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      font-size: 16px;
      transition: border 0.3s;
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #05A84D;
    }
    
    button:disabled {
      background: #CCCCCC;
      cursor: not-allowed;
    }
    
    .btn-retry {
      background: var(--info-color);
      margin-top: 10px;
    }
    
    .btn-retry:hover {
      background: #2980B9;
    }
    
    .record {
      border: 1px solid var(--border-color);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      background: white;
    }
    
    .record p {
      margin: 8px 0;
    }
    
    .record strong {
      color: var(--text-color);
    }
    
    .message {
      padding: 12px 15px;
      border-radius: 5px;
      margin: 15px 0;
      font-size: 15px;
    }
    
    .error {
      color: var(--error-color);
      background: #FDECEA;
      border: 1px solid #F5C3BB;
    }
    
    .success {
      color: var(--success-color);
      background: #E8F8F0;
      border: 1px solid #C8E6D3;
    }
    
    .info {
      color: var(--info-color);
      background: #EBF5FB;
      border: 1px solid #D4E6F1;
    }
    
    #locationStatus {
      font-weight: bold;
      margin: 20px 0;
      padding: 12px;
      border-radius: 5px;
    }
    
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #777777;
      font-size: 13px;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 15px;
      }
      
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      h2 {
        font-size: 18px;
      }
      
      button, input {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <p>系統初始化中，請稍候...</p>
  </div>
  
  <!-- 註冊容器 -->
  <div id="registerContainer" class="container">
    <h1>員工註冊</h1>
    <div class="form-group">
      <label for="name">姓名</label>
      <input type="text" id="name" placeholder="請輸入您的姓名" required>
    </div>
    <div class="form-group">
      <label for="employeeId">識別證卡號</label>
      <input type="text" id="employeeId" placeholder="請輸入您的員工編號" required>
    </div>
    <button id="registerBtn">註冊</button>
    <div id="registerMessage"></div>
  </div>
  
  <!-- 主容器 -->
  <div id="mainContainer" class="container">
    <h1 id="greeting">台北101打卡系統</h1>
    
    <div class="tab">
      <button id="attendanceTab" class="active">打卡</button>
      <button id="recordsTab">查詢記錄</button>
    </div>
    
    <!-- 打卡內容 -->
    <div id="attendanceContent">
      <div id="locationStatus" class="info">
        <p>正在取得定位資訊...</p>
      </div>
      <button id="checkInBtn" disabled>上班打卡</button>
      <button id="checkOutBtn" disabled>下班打卡</button>
      <div id="attendanceMessage"></div>
    </div>
    
    <!-- 記錄查詢內容 -->
    <div id="recordsContent" style="display: none;">
      <div class="form-group">
        <label for="recordDate">查詢日期</label>
        <input type="date" id="recordDate">
      </div>
      <button id="queryBtn">查詢記錄</button>
      <div id="recordsList"></div>
    </div>
  </div>
  
  <div class="footer">
    <p>台北101清潔出勤系統 &copy; 2023</p>
  </div>

  <script>
    // 增強版配置
    const config = {
      backendUrl: 'https://script.google.com/macros/s/AKfycbx5I9vg9m7nTmkb0qrU8gMGXeguzVJ__ALYnqZPLdxTXTbmQr0x4voXcS_l1HpqCsw/exec',
      maxRetries: 3,
      retryDelay: 2000,
      liffId: '2007700262-da76ZbYE' // 替換為您的LIFF ID
    };

    // 全局狀態
    const appState = {
      userId: null,
      isRegistered: false,
      userData: null,
      currentLocation: null,
      initializationAttempts: 0
    };

async function initializeApp() {
  try {
    // 顯示加載狀態
    showLoading(true);
    
    // 1. 初始化LIFF SDK（增加超時處理）
    await initializeLiffWithTimeout();
    
    // 2. 檢查網路連接
    await checkNetworkConnection();
    
    // 3. 檢查後端服務
    await checkBackendService();
    
    // 4. 獲取用戶資料
    const profile = await getProfileWithRetry();
    window.userId = profile.userId;
    
    // 5. 檢查註冊狀態
    const userStatus = await checkUserRegistration();
    window.isRegistered = userStatus.exists;
    window.userData = userStatus.data;
    
    // 初始化成功
    showAppInterface();
    
  } catch (error) {
    handleInitializationError(error);
  } finally {
    showLoading(false);
  }
}
// 帶超時的LIFF初始化
async function initializeLiffWithTimeout() {
  const LIFF_INIT_TIMEOUT = 10000; // 10秒超時
  
  try {
    await Promise.race([
      liff.init({
        liffId: 'YOUR_LIFF_ID',
        withLoginOnExternalBrowser: true
      }),
      new Promise((_, reject) => 
        setTimeout(() => reject(new Error('LIFF初始化超時')), LIFF_INIT_TIMEOUT)
      )
    ]);
    
    if (!liff.isLoggedIn()) {
      liff.login();
      throw new Error('需要登入LINE帳號');
    }
    
  } catch (error) {
    console.error('LIFF初始化失敗:', error);
    throw new Error('LINE服務初始化失敗: ' + error.message);
  }
}

// 帶重試的用戶資料獲取
async function getProfileWithRetry(maxRetries = 3) {
  let lastError;
  
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await liff.getProfile();
    } catch (error) {
      lastError = error;
      if (i < maxRetries - 1) {
        await new Promise(r => setTimeout(r, 1000));
      }
    }
  }
  
  throw lastError || new Error('無法獲取用戶資料');
}
// 檢查用戶註冊狀態
async function checkUserRegistration() {
  try {
    const response = await fetchWithRetry(
      `${config.backendUrl}?action=getEmployee&lineId=${window.userId}`,
      { cache: 'no-store' }
    );
    
    if (!response.ok) {
      throw new Error('後端服務回應異常');
    }
    
    return await response.json();
    
  } catch (error) {
    console.error('檢查註冊狀態失敗:', error);
    throw new Error('無法驗證用戶註冊狀態');
  }
}

// 顯示應用界面
function showAppInterface() {
  document.getElementById('loading').style.display = 'none';
  
  if (window.isRegistered) {
    document.getElementById('mainContainer').style.display = 'block';
    document.getElementById('greeting').textContent = 
      `您好，${window.userData?.name || '同仁'}！`;
    initializeGeolocation();
  } else {
    document.getElementById('registerContainer').style.display = 'block';
  }
}
// 初始化地理位置
function initializeGeolocation() {
  if (!navigator.geolocation) {
    showMessage('locationStatus', '您的瀏覽器不支持定位功能', 'error');
    return;
  }
  
  showMessage('locationStatus', '正在取得定位權限...', 'info');
  
  navigator.geolocation.getCurrentPosition(
    position => {
      window.currentLocation = {
        latitude: position.coords.latitude,
        longitude: position.coords.longitude
      };
      showMessage('locationStatus', '定位成功！', 'success');
      enableCheckInButtons();
    },
    error => {
      handleGeolocationError(error);
    },
    { 
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0 
    }
  );
}
    // 1. 初始化LIFF SDK
    async function initializeLiffSDK() {
      try {
        await liff.init({
          liffId: config.liffId,
          withLoginOnExternalBrowser: true
        });
        
        if (!liff.isInClient() && !liff.isLoggedIn()) {
          liff.login();
          throw new Error('需要登入LINE帳號');
        }
        
      } catch (error) {
        console.error('LIFF初始化失敗:', error);
        throw new Error('LINE服務初始化失敗，請稍後再試');
      }
    }

    // 2. 檢查網路連接
    async function checkNetworkConnection() {
      try {
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('網路連接超時')), 5000);
        
        const networkCheck = await Promise.race([
          fetch('https://connectivitycheck.gstatic.com/generate_204'),
          timeoutPromise
        ]);
        
        if (!networkCheck.ok) {
          throw new Error('網路連線不穩定');
        }
      } catch (error) {
        console.error('網路檢查失敗:', error);
        throw new Error('無法連接網路，請檢查您的網路設定');
      }
    }

    // 3. 檢查後端服務
    async function checkBackendService() {
      let attempts = 0;
      let lastError = null;
      
      while (attempts < config.maxRetries) {
        try {
          const response = await fetch(`${config.backendUrl}?action=healthcheck&rand=${Math.random()}`, {
            method: 'GET',
            cache: 'no-store'
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.status === 'healthy') {
              return true;
            }
          }
        } catch (error) {
          lastError = error;
          attempts++;
          if (attempts < config.maxRetries) {
            await new Promise(r => setTimeout(r, config.retryDelay));
          }
        }
      }
      
      throw lastError || new Error('後端服務無響應');
    }

    // 4. 獲取用戶資料
    async function fetchUserProfile() {
      try {
        const profile = await liff.getProfile();
        appState.userId = profile.userId;
      } catch (error) {
        console.error('獲取用戶資料失敗:', error);
        throw new Error('無法獲取用戶資訊');
      }
    }

    // 5. 檢查註冊狀態
    async function checkRegistrationStatus() {
      try {
        const response = await fetchWithRetry(
          `${config.backendUrl}?action=getEmployee&lineId=${appState.userId}`
        );
        
        const data = await response.json();
        
        appState.isRegistered = data.exists || false;
        appState.userData = data;
        
      } catch (error) {
        console.error('檢查註冊狀態失敗:', error);
        throw new Error('無法驗證用戶註冊狀態');
      }
    }

    // 帶重試的fetch函數
    async function fetchWithRetry(url, options = {}, retries = config.maxRetries) {
      let lastError;
      
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(`${url}&rand=${Math.random()}`, {
            ...options,
            cache: 'no-store'
          });
          
          if (response.ok) return response;
          
          throw new Error(`HTTP錯誤: ${response.status}`);
          
        } catch (error) {
          lastError = error;
          if (i < retries - 1) {
            await new Promise(r => setTimeout(r, config.retryDelay));
          }
        }
      }
      
      throw lastError;
    }

    // 顯示應用界面
    function showAppInterface() {
      if (appState.isRegistered) {
        document.getElementById('registerContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        
        // 設置用戶歡迎訊息
        document.getElementById('greeting').textContent = 
          `您好，${appState.userData.name || '同仁'}！`;
        
        // 獲取地理位置
        getGeolocation();
        
        // 設置事件監聽器
        setupEventListeners();
      } else {
        document.getElementById('registerContainer').style.display = 'block';
        document.getElementById('mainContainer').style.display = 'none';
        
        // 設置註冊按鈕事件
        document.getElementById('registerBtn').addEventListener('click', registerUser);
      }
    }

    // 獲取地理位置
    function getGeolocation() {
      if (!navigator.geolocation) {
        showMessage('locationStatus', '您的瀏覽器不支持定位功能', 'error');
        return;
      }
      
      showMessage('locationStatus', '正在取得定位權限...', 'info');
      
      navigator.geolocation.getCurrentPosition(
        position => {
          appState.currentLocation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy
          };
          
          showMessage('locationStatus', 
            `定位成功！<br><small>精確度: ±${Math.round(appState.currentLocation.accuracy)}公尺</small>`, 
            'success');
            
          document.getElementById('checkInBtn').disabled = false;
          document.getElementById('checkOutBtn').disabled = false;
        },
        error => {
          console.error('獲取位置失敗:', error);
          showMessage('locationStatus', 
            `定位失敗: ${getLocationErrorText(error)}<br>
            <small>請允許定位權限並重新載入頁面</small>`, 
            'error');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    // 獲取定位錯誤訊息
    function getLocationErrorText(error) {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          return "定位權限被拒絕";
        case error.POSITION_UNAVAILABLE:
          return "定位資訊不可用";
        case error.TIMEOUT:
          return "定位請求超時";
        case error.UNKNOWN_ERROR:
          return "未知定位錯誤";
        default:
          return "無法取得位置";
      }
    }

    // 註冊用戶
    async function registerUser() {
      const name = document.getElementById('name').value.trim();
      const employeeId = document.getElementById('employeeId').value.trim();
      
      if (!name || !employeeId) {
        showMessage('registerMessage', '請填寫所有欄位', 'error');
        return;
      }
      
      try {
        showMessage('registerMessage', '註冊中，請稍候...', 'info');
        document.getElementById('registerBtn').disabled = true;
        
        const params = new URLSearchParams({
          action: 'register',
          lineId: appState.userId,
          name: name,
          employeeId: employeeId,
          timestamp: Date.now()
        });
        
        const response = await fetchWithRetry(config.backendUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: params
        });
        
        const data = await response.json();
        
        if (data.status !== 'success') {
          throw new Error(data.error || '註冊失敗');
        }
        
        showMessage('registerMessage', '註冊成功！正在載入系統...', 'success');
        
        // 更新應用狀態
        appState.isRegistered = true;
        appState.userData = data.data;
        
        // 延遲後顯示主界面
        setTimeout(() => {
          document.getElementById('registerContainer').style.display = 'none';
          document.getElementById('mainContainer').style.display = 'block';
          document.getElementById('greeting').textContent = `您好，${name}！`;
          getGeolocation();
        }, 1500);
        
      } catch (error) {
        console.error('註冊失敗:', error);
        
        let errorMsg = error.message;
        if (error.message.includes('Failed to fetch')) {
          errorMsg = '無法連接伺服器，請檢查網路連線';
        }
        
        showMessage('registerMessage', `
          <p><strong>註冊失敗</strong></p>
          <p>${errorMsg}</p>
          <button class="btn-retry" onclick="registerUser()">重試註冊</button>
        `, 'error');
        
      } finally {
        document.getElementById('registerBtn').disabled = false;
      }
    }

    // 設置事件監聽器
    function setupEventListeners() {
      // 打卡按鈕
      document.getElementById('checkInBtn').addEventListener('click', () => recordAttendance('in'));
      document.getElementById('checkOutBtn').addEventListener('click', () => recordAttendance('out'));
      
      // 標籤切換
      document.getElementById('attendanceTab').addEventListener('click', () => {
        document.getElementById('attendanceContent').style.display = 'block';
        document.getElementById('recordsContent').style.display = 'none';
        document.getElementById('attendanceTab').classList.add('active');
        document.getElementById('recordsTab').classList.remove('active');
      });
      
      document.getElementById('recordsTab').addEventListener('click', () => {
        document.getElementById('attendanceContent').style.display = 'none';
        document.getElementById('recordsContent').style.display = 'block';
        document.getElementById('attendanceTab').classList.remove('active');
        document.getElementById('recordsTab').classList.add('active');
        
        // 設置默認日期為今天
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('recordDate').value = today;
        
        // 查詢記錄
        queryAttendanceRecords(today);
      });
      
      // 查詢按鈕
      document.getElementById('queryBtn').addEventListener('click', () => {
        const date = document.getElementById('recordDate').value;
        queryAttendanceRecords(date);
      });
    }

    // 打卡功能
    async function recordAttendance(type) {
      if (!appState.currentLocation) {
        showMessage('attendanceMessage', '無法取得位置資訊，請重試', 'error');
        return;
      }
      
      try {
        showMessage('attendanceMessage', '打卡中，請稍候...', 'info');
        document.getElementById('checkInBtn').disabled = true;
        document.getElementById('checkOutBtn').disabled = true;
        
        const params = new URLSearchParams({
          action: type === 'in' ? 'checkIn' : 'checkOut',
          lineId: appState.userId,
          latitude: appState.currentLocation.latitude,
          longitude: appState.currentLocation.longitude,
          timestamp: Date.now()
        });
        
        const response = await fetchWithRetry(config.backendUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: params
        });
        
        const data = await response.json();
        
        if (data.status !== 'success') {
          throw new Error(data.error || '打卡失敗');
        }
        
        const action = type === 'in' ? '上班' : '下班';
        const message = `
          <p><strong>${action}打卡成功！</strong></p>
          <p>時間: ${data.data?.time || '未知'}</p>
          <p>位置: ${data.data?.address || '台北101附近'}</p>
        `;
        
        showMessage('attendanceMessage', message, 'success');
        
      } catch (error) {
        console.error('打卡失敗:', error);
        
        let errorMsg = error.message;
        if (error.message.includes('Failed to fetch')) {
          errorMsg = '網路錯誤，請檢查您的連線';
        }
        
        showMessage('attendanceMessage', `
          <p><strong>打卡失敗</strong></p>
          <p>${errorMsg}</p>
          <button class="btn-retry" onclick="recordAttendance('${type}')">重試打卡</button>
        `, 'error');
        
      } finally {
        document.getElementById('checkInBtn').disabled = false;
        document.getElementById('checkOutBtn').disabled = false;
      }
    }

    // 查詢打卡記錄
    async function queryAttendanceRecords(date) {
      try {
        const recordsList = document.getElementById('recordsList');
        recordsList.innerHTML = '<div class="info message">查詢中，請稍候...</div>';
        
        const response = await fetchWithRetry(
          `${config.backendUrl}?action=getAttendance&lineId=${appState.userId}&date=${date}`
        );
        
        const data = await response.json();
        
        if (!data.records || data.records.length === 0) {
          recordsList.innerHTML = '<div class="info message">沒有找到打卡記錄</div>';
          return;
        }
        
        // 按時間排序
        const sortedRecords = data.records.sort((a, b) => a.time.localeCompare(b.time));
        
        // 顯示記錄
        recordsList.innerHTML = '';
        sortedRecords.forEach(record => {
          const recordDiv = document.createElement('div');
          recordDiv.className = 'record';
          recordDiv.innerHTML = `
            <p><strong>日期:</strong> ${record.date}</p>
            <p><strong>時間:</strong> ${record.time}</p>
            <p><strong>類型:</strong> ${record.type === 'in' ? '上班打卡' : '下班打卡'}</p>
            <p><strong>位置:</strong> ${record.address || '台北101附近'}</p>
          `;
          recordsList.appendChild(recordDiv);
        });
        
      } catch (error) {
        console.error('查詢記錄失敗:', error);
        document.getElementById('recordsList').innerHTML = `
          <div class="error message">
            <p><strong>查詢失敗</strong></p>
            <p>${error.message || '未知錯誤'}</p>
            <button class="btn-retry" onclick="queryAttendanceRecords(document.getElementById('recordDate').value)">重試查詢</button>
          </div>
        `;
      }
    }

    // 顯示/隱藏加載狀態
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    // 顯示訊息
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.className = `${type} message`;
      element.innerHTML = message;
    }

    // 錯誤處理
    function handleInitializationError(error) {
      console.error('初始化錯誤:', error);
      
      const errorContainer = document.getElementById('loading');
      errorContainer.innerHTML = `
        <div class="error-container">
          <h3>系統初始化失敗</h3>
          <p>${error.message || '未知錯誤'}</p>
          
          <div class="debug-info">
            <p><strong>偵錯資訊：</strong></p>
            <ul>
              <li>時間: ${new Date().toLocaleString()}</li>
              <li>嘗試次數: ${appState.initializationAttempts}</li>
              <li>用戶ID: ${appState.userId || '未獲取'}</li>
              <li>後端狀態: <span id="backendStatus">檢查中...</span></li>
            </ul>
          </div>
          
          <div class="action-buttons">
            <button class="retry-btn" onclick="hardReload()">徹底重新載入</button>
            <button class="feedback-btn" onclick="reportIssue()">回報問題</button>
          </div>
        </div>
      `;
      
      // 檢查後端狀態
      checkBackendStatus();
    }

    // 檢查後端狀態
    async function checkBackendStatus() {
      try {
        const response = await fetch(`${config.backendUrl}?action=healthcheck&rand=${Math.random()}`);
        const statusElement = document.getElementById('backendStatus');
        
        if (response.ok) {
          const data = await response.json();
          statusElement.innerHTML = `正常運作 (${data.version})`;
          statusElement.style.color = 'green';
        } else {
          statusElement.textContent = '服務異常';
          statusElement.style.color = 'red';
        }
      } catch (e) {
        document.getElementById('backendStatus').textContent = '無法連接';
        document.getElementById('backendStatus').style.color = 'red';
      }
    }

    // 徹底重新載入
    function hardReload() {
      // 強制清除緩存重新載入
      window.location.href = window.location.href.split('?')[0] + 
        '?rand=' + Math.random() + 
        '&cache=clear&timestamp=' + Date.now();
    }

    // 回報問題
    function reportIssue() {
      const issueDetails = {
        userId: appState.userId,
        timestamp: new Date().toISOString(),
        attempts: appState.initializationAttempts,
        userAgent: navigator.userAgent
      };
      
      // 這裡可以實現問題回報邏輯
      console.log('回報問題:', issueDetails);
      alert('問題已記錄，將由技術人員處理');
    }

    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 添加版本標記防止緩存
      const version = 'v2.0.0-' + Date.now();
      document.querySelector('html').setAttribute('data-version', version);
      
      initializeApp();
    });

    // 全局函數
    window.hardReload = hardReload;
    window.reportIssue = reportIssue;
  </script>
</body>
</html>
