<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台北101打卡系統 (LINE版)</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 100%;
            padding: 15px;
            box-sizing: border-box;
        }
        h1, h2 {
            color: #06C755; /* LINE 綠色 */
        }
        button {
            background: #06C755;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
            transition: background 0.3s;
            width: 100%;
        }
        button:hover {
            background: #05a344;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .success {
            background: #e6f4ea;
            color: #1e8e3e;
            border-left: 4px solid #1e8e3e;
        }
        .error {
            background: #fce8e6;
            color: #d93025;
            border-left: 4px solid #d93025;
        }
        .info {
            background: #e8f0fe;
            color: #1967d2;
            border-left: 4px solid #1967d2;
        }
        textarea {
            width: 100%;
            height: 120px;
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 16px;
            box-sizing: border-box;
        }
        .section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #06C755;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-details {
            margin-top: 10px;
            padding: 10px;
            background: #fff3f3;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #d93025;
            word-break: break-all;
        }
        .user-info {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>台北101打卡系統 (LINE版)</h1>
        <div id="userInfo" class="user-info"></div>
        
        <div class="section">
            <h2>1. 後端服務設定</h2>
            <div>
                <label for="scriptUrl">Google Apps Script 部署URL:</label>
                <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/..." style="font-family: monospace;">
            </div>
            <button id="initBtn">測試連接後端</button>
            <div id="initResult" class="result"></div>
        </div>

        <div class="section">
            <h2>2. Google Sheets 讀取測試</h2>
            <div>
                <label for="sheetsRange">資料範圍 (例如 Sheet1!A1:B2):</label>
                <input type="text" id="sheetsRange" value="Sheet1!A1:B2">
            </div>
            <button id="testSheetsBtn" disabled>測試讀取資料</button>
            <div id="sheetsResult" class="result"></div>
            <textarea id="sheetsData" readonly placeholder="讀取結果將顯示在這裡"></textarea>
        </div>

        <div class="section">
            <h2>3. 位置打卡</h2>
            <div>
                <label for="testName">您的姓名:</label>
                <input type="text" id="testName" placeholder="請輸入姓名">
            </div>
            <div>
                <label for="testEmpId">員工編號 (6位數字):</label>
                <input type="text" id="testEmpId" placeholder="123456" maxlength="6">
            </div>
            <div>
                <label for="writeSheetName">工作表名稱:</label>
                <input type="text" id="writeSheetName" value="打卡記錄">
            </div>
            <button id="checkInBtn" disabled>打卡</button>
            <div id="writeResult" class="result"></div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // DOM元素
        const initBtn = document.getElementById('initBtn');
        const testSheetsBtn = document.getElementById('testSheetsBtn');
        const checkInBtn = document.getElementById('checkInBtn');
        const scriptUrlInput = document.getElementById('scriptUrl');
        
        const initResult = document.getElementById('initResult');
        const sheetsResult = document.getElementById('sheetsResult');
        const writeResult = document.getElementById('writeResult');
        const userInfoDiv = document.getElementById('userInfo');
        
        const sheetsData = document.getElementById('sheetsData');

        let scriptUrl = '';
        let userId = '';
        let displayName = '';

        // 初始化LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: '2007700262-da76ZbYE' }); // 請替換為您的LIFF ID
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;
                
                userInfoDiv.innerHTML = `
                    <strong>用戶資訊:</strong><br>
                    名稱: ${displayName}<br>
                    LINE User ID: ${userId}
                `;
                
                // 自動填入姓名欄位
                document.getElementById('testName').value = displayName;
                
            } catch (error) {
                console.error('LIFF初始化失敗:', error);
                userInfoDiv.innerHTML = '無法獲取用戶資訊';
            }
        }

        // 初始化 - 測試後端連接
        initBtn.addEventListener('click', async () => {
            scriptUrl = scriptUrlInput.value.trim();
            
            if (!scriptUrl) {
                showResult(initResult, '請輸入Google Apps Script部署URL', 'error');
                return;
            }

            try {
                showLoading(initResult, '正在連接後端服務...');
                
                const response = await fetch(`${scriptUrl}?action=test`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP錯誤! 狀態碼: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    showResult(initResult, '後端服務連接成功!', 'success');
                    testSheetsBtn.disabled = false;
                    checkInBtn.disabled = false;
                } else {
                    throw new Error(data.message || '後端服務返回錯誤');
                }
            } catch (error) {
                console.error('連接失敗:', error);
                showError(initResult, `連接失敗: ${error.message}`, error);
            }
        });

        // 測試讀取Google Sheet
        testSheetsBtn.addEventListener('click', async () => {
            const range = document.getElementById('sheetsRange').value.trim();
            
            if (!range) {
                showResult(sheetsResult, '請輸入資料範圍', 'error');
                return;
            }

            try {
                showLoading(sheetsResult, '正在讀取資料...');
                sheetsData.value = '讀取中...';

                const response = await fetch(`${scriptUrl}?action=read&range=${encodeURIComponent(range)}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP錯誤! 狀態碼: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    sheetsData.value = JSON.stringify(data.data, null, 2);
                    showResult(sheetsResult, `成功讀取 ${data.data.length || 0} 行資料`, 'success');
                } else {
                    throw new Error(data.message || '讀取資料失敗');
                }
            } catch (error) {
                console.error('讀取失敗:', error);
                sheetsData.value = `錯誤: ${error.message}`;
                showError(sheetsResult, `讀取失敗: ${error.message}`, error);
            }
        });

        // 打卡功能
        checkInBtn.addEventListener('click', async () => {
            const name = document.getElementById('testName').value.trim();
            const empId = document.getElementById('testEmpId').value.trim();
            const sheetName = document.getElementById('writeSheetName').value.trim();

            if (!name || !empId || !sheetName) {
                showResult(writeResult, '請填寫所有欄位', 'error');
                return;
            }

            if (empId.length !== 6 || !/^\d+$/.test(empId)) {
                showResult(writeResult, '員工編號必須是6位數字', 'error');
                return;
            }

            try {
                showLoading(writeResult, '正在打卡中...');

                // 獲取用戶位置
                const location = await liff.getLocation();
                if (!location) {
                    throw new Error('無法獲取位置資訊');
                }

                // 使用URLSearchParams解決CORS問題
                const formData = new URLSearchParams();
                formData.append('action', 'write');
                formData.append('name', name);
                formData.append('empId', empId);
                formData.append('sheetName', sheetName);
                formData.append('latitude', location.latitude);
                formData.append('longitude', location.longitude);
                formData.append('lineUserId', userId);

                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP錯誤! 狀態碼: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    showResult(writeResult, '打卡成功!', 'success');
                    
                    // 顯示打卡成功訊息
                    if (liff.isInClient()) {
                        liff.sendMessages([
                            {
                                type: 'text',
                                text: `打卡成功！\n姓名: ${name}\n員工編號: ${empId}\n時間: ${new Date().toLocaleString()}`
                            }
                        ]).then(() => {
                            console.log('訊息已發送');
                        }).catch((err) => {
                            console.error('發送訊息失敗:', err);
                        });
                    }
                } else {
                    throw new Error(data.message || '打卡失敗');
                }
            } catch (error) {
                console.error('打卡失敗:', error);
                showError(writeResult, `打卡失敗: ${error.message}`, error);
            }
        });

        // 顯示加載狀態
        function showLoading(element, message) {
            element.innerHTML = `<span class="loading"></span> ${message}`;
            element.className = 'result info';
        }

        // 顯示結果
        function showResult(element, message, type) {
            element.innerHTML = message;
            element.className = 'result ' + type;
        }

        // 顯示錯誤詳情
        function showError(element, message, error) {
            element.innerHTML = `${message}<div class="error-details">${error.stack || error.message}</div>`;
            element.className = 'result error';
        }

        // 初始化應用
        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();
        });
    </script>
</body>
</html>

