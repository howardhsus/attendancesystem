<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台北101打卡系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #loading {
      text-align: center;
      padding: 20px;
      font-size: 18px;
    }
    .tab {
      display: flex;
      margin-bottom: 20px;
      border-radius: 5px;
      overflow: hidden;
    }
    .tab button {
      flex: 1;
      padding: 12px;
      background: #ddd;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    .tab button.active {
      background: #06c755;
      color: white;
      font-weight: bold;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, button {
      width: 100%;
      padding: 12px;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 16px;
    }
    button {
      background: #06c755;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .record {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      background: white;
    }
    .record p {
      margin: 5px 0;
    }
    .error {
      color: #e74c3c;
      background: #fdecea;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success {
      color: #2ecc71;
      background: #e8f8f0;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .info {
      color: #3498db;
      background: #ebf5fb;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #06c755;
      padding-bottom: 10px;
      margin-top: 0;
    }
    #locationStatus {
      font-weight: bold;
      margin: 15px 0;
    }
    #debugInfo {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="loading">
    <p>系統載入中，請稍候...</p>
  </div>
  
  <div id="registerContainer" class="container">
    <h2>員工註冊</h2>
    <div class="form-group">
      <label for="name">姓名</label>
      <input type="text" id="name" placeholder="請輸入您的姓名" required>
    </div>
    <div class="form-group">
      <label for="employeeId">識別證卡號</label>
      <input type="text" id="employeeId" placeholder="請輸入您的員工編號" required>
    </div>
    <button id="registerBtn">註冊</button>
    <div id="registerMessage"></div>
    <div id="debugInfo"></div>
  </div>
  
  <div id="mainContainer" class="container">
    <div class="tab">
      <button id="attendanceTab" class="active">打卡</button>
      <button id="recordsTab">查詢記錄</button>
    </div>
    
    <div id="attendanceContent">
      <h2 id="greeting"></h2>
      <div id="locationStatus" class="info">正在取得定位資訊...</div>
      <button id="checkInBtn" disabled>上班打卡</button>
      <button id="checkOutBtn" disabled>下班打卡</button>
      <div id="attendanceMessage"></div>
    </div>
    
    <div id="recordsContent" style="display: none;">
      <h2>打卡記錄查詢</h2>
      <div class="form-group">
        <label for="recordDate">查詢日期</label>
        <input type="date" id="recordDate">
      </div>
      <button id="queryBtn">查詢</button>
      <div id="recordsList"></div>
    </div>
  </div>

  <script>
    // 配置
    const config = {
      backendUrl: 'https://script.google.com/macros/s/AKfycbx5I9vg9m7nTmkb0qrU8gMGXeguzVJ__ALYnqZPLdxTXTbmQr0x4voXcS_l1HpqCsw/exec',
      debugMode: true // 開發時設為true，上線後可設為false
    };
    
    // 全局變量
    let userId = null;
    let isRegistered = false;
    let currentLocation = null;
    let userName = '';
    let employeeId = '';
    
    // 初始化LIFF
    async function initializeLiff() {
      try {
        // 顯示載入狀態
        document.getElementById('loading').textContent = '正在初始化LINE LIFF...';
        
        await liff.init({ liffId: '2007700262-da76ZbYE' });
        
        if (!liff.isLoggedIn()) {
          document.getElementById('loading').textContent = '正在登入LINE...';
          liff.login();
          return;
        }
        
        // 獲取用戶資料
        document.getElementById('loading').textContent = '正在獲取用戶資料...';
        const profile = await liff.getProfile();
        userId = profile.userId;
        
        // 檢查註冊狀態
        document.getElementById('loading').textContent = '正在檢查註冊狀態...';
        const registered = await checkRegistration();
        
        // 初始化UI
        document.getElementById('loading').style.display = 'none';
        if (registered) {
          showMainApp();
        } else {
          document.getElementById('registerContainer').style.display = 'block';
        }
        
        // 獲取位置
        getLocation();
        
        // 初始化事件監聽器
        setupEventListeners();
        
      } catch (error) {
        console.error('初始化失敗:', error);
        showFatalError('系統初始化失敗: ' + error.message);
      }
    }
    
    // 檢查註冊狀態
    async function checkRegistration() {
      try {
        const url = `${config.backendUrl}?action=getEmployee&lineId=${userId}&timestamp=${Date.now()}`;
        logDebug('檢查註冊狀態:', url);
        
        const response = await fetch(url);
        logDebug('回應狀態:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP錯誤: ${response.status}`);
        }
        
        const data = await response.json();
        logDebug('註冊檢查結果:', data);
        
        if (data.data?.exists) {
          isRegistered = true;
          userName = data.data.name;
          employeeId = data.data.employeeId;
          return true;
        }
        return false;
        
      } catch (error) {
        console.warn('檢查註冊失敗:', error);
        logDebug('檢查註冊錯誤:', error);
        return false;
      }
    }
    
    // 註冊功能
    async function register() {
      const name = document.getElementById('name').value.trim();
      const empId = document.getElementById('employeeId').value.trim();
      
      // 驗證輸入
      if (!name || !empId) {
        showMessage('registerMessage', '請填寫所有欄位', 'error');
        return;
      }
      
      try {
        // 顯示載入狀態
        showMessage('registerMessage', '註冊中，請稍候...', 'info');
        
        // 準備請求數據
        const params = new URLSearchParams();
        params.append('action', 'register');
        params.append('lineId', userId);
        params.append('name', name);
        params.append('employeeId', empId);
        
        logDebug('發送註冊請求:', params.toString());
        
        // 發送請求
        const response = await fetch(config.backendUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: params
        });
        
        logDebug('註冊回應狀態:', response.status);
        
        // 檢查回應
        if (!response.ok) {
          const errorText = await response.text();
          logDebug('註冊失敗:', errorText);
          throw new Error(`請求失敗: ${response.status}`);
        }
        
        // 解析回應
        const data = await response.json();
        logDebug('註冊結果:', data);
        
        // 處理回應
        if (data.status === 'success') {
          // 更新全局狀態
          isRegistered = true;
          userName = data.data.name;
          employeeId = data.data.employeeId;
          
          // 顯示成功訊息
          showMessage('registerMessage', '註冊成功！正在跳轉...', 'success');
          
          // 立即跳轉
          showMainApp();
          
        } else {
          throw new Error(data.message || '註冊失敗');
        }
        
      } catch (error) {
        console.error('註冊錯誤:', error);
        logDebug('註冊錯誤詳情:', error);
        
        // 處理錯誤訊息
        let errorMsg = '註冊失敗';
        if (error.message.includes('Failed to fetch')) {
          errorMsg = '無法連接伺服器，請檢查網路連線';
        } else if (error.message.includes('HTTP錯誤')) {
          errorMsg = `伺服器錯誤: ${error.message}`;
        } else {
          errorMsg = error.message;
        }
        
        // 顯示錯誤
        showMessage('registerMessage', errorMsg, 'error');
      }
    }
    
    // 顯示主應用
    function showMainApp() {
      document.getElementById('registerContainer').style.display = 'none';
      document.getElementById('mainContainer').style.display = 'block';
      
      // 設置問候語
      const hour = new Date().getHours();
      let greeting = '';
      if (hour < 12) greeting = '早安';
      else if (hour < 18) greeting = '午安';
      else greeting = '晚安';
      
      document.getElementById('greeting').textContent = `${greeting}，${userName} (${employeeId})！`;
    }
    
    // 獲取地理位置
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            currentLocation = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            };
            
            document.getElementById('locationStatus').className = 'success';
            document.getElementById('locationStatus').innerHTML = 
              '定位成功！您現在可以打卡<br><small>此系統僅限台北101大樓附近使用</small>';
            
            document.getElementById('checkInBtn').disabled = false;
            document.getElementById('checkOutBtn').disabled = false;
          },
          error => {
            console.error('獲取位置失敗:', error);
            
            document.getElementById('locationStatus').className = 'error';
            document.getElementById('locationStatus').textContent = 
              '定位失敗: ' + getLocationErrorMessage(error);
            
            document.getElementById('checkInBtn').disabled = true;
            document.getElementById('checkOutBtn').disabled = true;
          },
          { 
            enableHighAccuracy: true, 
            timeout: 10000, 
            maximumAge: 0 
          }
        );
      } else {
        document.getElementById('locationStatus').className = 'error';
        document.getElementById('locationStatus').textContent = 
          '您的瀏覽器不支持定位功能';
      }
    }
    
    // 獲取定位錯誤訊息
    function getLocationErrorMessage(error) {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          return "您拒絕了定位請求，請允許定位權限";
        case error.POSITION_UNAVAILABLE:
          return "定位資訊不可用";
        case error.TIMEOUT:
          return "獲取位置超時，請重試";
        case error.UNKNOWN_ERROR:
          return "發生未知錯誤";
        default:
          return error.message;
      }
    }
    
    // 打卡功能
    async function recordAttendance(type) {
      if (!currentLocation) {
        showMessage('attendanceMessage', '無法獲取位置信息', 'error');
        return;
      }
      
      try {
        showMessage('attendanceMessage', `${type === 'in' ? '上班' : '下班'}打卡中...`, 'info');
        
        const params = new URLSearchParams();
        params.append('action', type === 'in' ? 'checkIn' : 'checkOut');
        params.append('lineId', userId);
        params.append('latitude', currentLocation.latitude);
        params.append('longitude', currentLocation.longitude);
        
        logDebug('發送打卡請求:', params.toString());
        
        const response = await fetch(config.backendUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: params
        });
        
        logDebug('打卡回應狀態:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`請求失敗: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        logDebug('打卡結果:', data);
        
        if (data.status === 'success') {
          const action = type === 'in' ? '上班' : '下班';
          const message = `
            <strong>${action}打卡成功！</strong>
            <p>時間: ${data.data.time}</p>
            <p>距離台北101: ${data.data.distance}公尺</p>
            <p>位置: ${data.data.address}</p>
          `;
          showMessage('attendanceMessage', message, 'success');
        } else {
          throw new Error(data.message || '打卡失敗');
        }
        
      } catch (error) {
        console.error('打卡錯誤:', error);
        logDebug('打卡錯誤詳情:', error);
        
        let errorMsg = '打卡失敗';
        if (error.message.includes('Failed to fetch')) {
          errorMsg = '無法連接伺服器，請檢查網路';
        } else {
          errorMsg = error.message;
        }
        
        showMessage('attendanceMessage', errorMsg, 'error');
      }
    }
    
    // 查詢打卡記錄
    async function queryRecords(date) {
      try {
        document.getElementById('recordsList').innerHTML = '<p>查詢中...</p>';
        
        const url = `${config.backendUrl}?action=getAttendance&lineId=${userId}&date=${date}`;
        logDebug('查詢記錄請求:', url);
        
        const response = await fetch(url);
        logDebug('查詢回應狀態:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP錯誤: ${response.status}`);
        }
        
        const data = await response.json();
        logDebug('查詢結果:', data);
        
        const recordsList = document.getElementById('recordsList');
        recordsList.innerHTML = '';
        
        if (data.data?.records?.length > 0) {
          // 按時間排序
          const sortedRecords = data.data.records.sort((a, b) => a.time.localeCompare(b.time));
          
          sortedRecords.forEach(record => {
            const recordDiv = document.createElement('div');
            recordDiv.className = 'record';
            recordDiv.innerHTML = `
              <p><strong>日期:</strong> ${record.date}</p>
              <p><strong>時間:</strong> ${record.time}</p>
              <p><strong>類型:</strong> ${record.type === 'in' ? '上班打卡' : '下班打卡'}</p>
              <p><strong>位置:</strong> ${record.address}</p>
            `;
            recordsList.appendChild(recordDiv);
          });
        } else {
          recordsList.innerHTML = '<div class="info">沒有找到記錄</div>';
        }
        
      } catch (error) {
        console.error('查詢記錄失敗:', error);
        logDebug('查詢錯誤:', error);
        
        document.getElementById('recordsList').innerHTML = 
          '<div class="error">查詢記錄失敗，請稍後再試</div>';
      }
    }
    
    // 初始化事件監聽器
    function setupEventListeners() {
      // 註冊按鈕
      document.getElementById('registerBtn').addEventListener('click', register);
      
      // 打卡按鈕
      document.getElementById('checkInBtn').addEventListener('click', () => recordAttendance('in'));
      document.getElementById('checkOutBtn').addEventListener('click', () => recordAttendance('out'));
      
      // 標籤切換
      document.getElementById('attendanceTab').addEventListener('click', () => {
        document.getElementById('attendanceContent').style.display = 'block';
        document.getElementById('recordsContent').style.display = 'none';
        document.getElementById('attendanceTab').classList.add('active');
        document.getElementById('recordsTab').classList.remove('active');
      });
      
      document.getElementById('recordsTab').addEventListener('click', () => {
        document.getElementById('attendanceContent').style.display = 'none';
        document.getElementById('recordsContent').style.display = 'block';
        document.getElementById('attendanceTab').classList.remove('active');
        document.getElementById('recordsTab').classList.add('active');
        
        // 設置默認日期為今天
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('recordDate').value = today;
        
        // 查詢記錄
        queryRecords(today);
      });
      
      // 查詢按鈕
      document.getElementById('queryBtn').addEventListener('click', () => {
        const date = document.getElementById('recordDate').value;
        queryRecords(date);
      });
    }
    
    // 顯示訊息
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = message;
      element.className = type;
    }
    
    // 顯示致命錯誤
    function showFatalError(message) {
      document.getElementById('loading').innerHTML = `
        <div class="error">
          <h3>系統錯誤</h3>
          <p>${message}</p>
          <button onclick="window.location.reload()" style="padding: 10px; margin-top: 10px;">
            重新載入
          </button>
        </div>
      `;
    }
    
    // 記錄調試信息
    function logDebug(...args) {
      if (config.debugMode) {
        console.log(...args);
        
        const debugInfo = document.getElementById('debugInfo');
        if (debugInfo) {
          debugInfo.style.display = 'block';
          debugInfo.innerHTML += `
            <div style="margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
              <small>${new Date().toLocaleTimeString()}</small>
              <pre style="margin: 5px 0; white-space: pre-wrap;">${args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
              ).join(' ')}</pre>
            </div>
          `;
        }
      }
    }
    
    // 初始化應用
    document.addEventListener('DOMContentLoaded', () => {
      initializeLiff();
    });
  </script>
</body>
</html>
