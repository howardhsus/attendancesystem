<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台北101員工打卡系統</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #06C755;
        }
        button {
            background: #06C755;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
            transition: background 0.3s;
            width: 100%;
        }
        button:hover {
            background: #05a344;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .btn-checkin {
            background: #38a169;
        }
        .btn-checkout {
            background: #e53e3e;
        }
        .btn-primary {
            background: #1a365d;
        }
        .result {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .success {
            background: #e6f4ea;
            color: #1e8e3e;
            border-left: 4px solid #1e8e3e;
        }
        .error {
            background: #fce8e6;
            color: #d93025;
            border-left: 4px solid #d93025;
        }
        .info {
            background: #e8f0fe;
            color: #1967d2;
            border-left: 4px solid #1967d2;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 16px;
            box-sizing: border-box;
        }
        .section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #06C755;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-details {
            margin-top: 10px;
            padding: 10px;
            background: #fff3f3;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #d93025;
            word-break: break-all;
        }
        .user-info {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .location-info {
            margin-top: 10px;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 6px;
        }
        .check-type {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .check-type button {
            flex: 1;
        }
        .record-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #06C755;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>台北101員工打卡系統</h1>
        <div id="userInfo" class="user-info">載入用戶資訊中...</div>
        
        <div class="section">
            <h2>1. 後端服務設定</h2>
            <div>
                <label for="scriptUrl">Google Apps Script 部署URL:</label>
                <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/..." 
                       value="https://script.google.com/macros/s/AKfycbzp9Uv-dygOmSeh4cZAYTntOJSwni6yG3fccJbLTsb2J9Ft8GVReWepVRt2uVAE52m3bw/exec">
            </div>
            <button id="initBtn">測試連接後端</button>
            <div id="initResult" class="result"></div>
        </div>

        <div class="section">
            <h2>2. 位置打卡</h2>
            <div>
                <label for="testName">您的姓名:</label>
                <input type="text" id="testName" placeholder="請輸入姓名">
            </div>
            <div>
                <label for="testEmpId">員工編號 (6位數字):</label>
                <input type="text" id="testEmpId" placeholder="123456" maxlength="6">
            </div>
            <div>
                <label for="writeSheetName">工作表名稱:</label>
                <input type="text" id="writeSheetName" value="打卡記錄">
            </div>
            <div id="locationInfo" class="location-info">位置資訊將在此顯示</div>
            
            <div class="check-type">
                <button id="checkInBtn" class="btn-checkin" disabled>上班打卡</button>
                <button id="checkOutBtn" class="btn-checkout" disabled>下班打卡</button>
            </div>
            
            <button id="showRecordsBtn" class="btn-primary" disabled>查看打卡記錄</button>
            <div id="writeResult" class="result"></div>
            <div id="recordsContainer"></div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // DOM元素
        const initBtn = document.getElementById('initBtn');
        const checkInBtn = document.getElementById('checkInBtn');
        const checkOutBtn = document.getElementById('checkOutBtn');
        const showRecordsBtn = document.getElementById('showRecordsBtn');
        const scriptUrlInput = document.getElementById('scriptUrl');
        const initResult = document.getElementById('initResult');
        const writeResult = document.getElementById('writeResult');
        const userInfoDiv = document.getElementById('userInfo');
        const locationInfoDiv = document.getElementById('locationInfo');
        const recordsContainer = document.getElementById('recordsContainer');

        let scriptUrl = '';
        let userId = '';
        let displayName = '';
        let empId = '';

        // 初始化LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: '2007700262-da76ZbYE' });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;
                
                userInfoDiv.innerHTML = `
                    <strong>用戶資訊:</strong><br>
                    名稱: ${displayName}<br>
                    LINE User ID: ${userId}
                `;
                
                // 自動填入姓名欄位
                document.getElementById('testName').value = displayName;
                
            } catch (error) {
                console.error('LIFF初始化失敗:', error);
                userInfoDiv.innerHTML = '無法獲取用戶資訊: ' + error.message;
            }
        }

        // 初始化 - 測試後端連接
        initBtn.addEventListener('click', async () => {
            scriptUrl = scriptUrlInput.value.trim();
            
            if (!scriptUrl) {
                showResult(initResult, '請輸入Google Apps Script部署URL', 'error');
                return;
            }

            try {
                showLoading(initResult, '正在連接後端服務...');
                
                const response = await fetch(`${scriptUrl}?action=test`);
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP錯誤! 狀態碼: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    showResult(initResult, '後端服務連接成功!', 'success');
                    checkInBtn.disabled = false;
                    checkOutBtn.disabled = false;
                    showRecordsBtn.disabled = false;
                    
                    // 檢查用戶是否已註冊
                    await checkUserRegistration();
                } else {
                    throw new Error(data.message || '後端服務返回錯誤');
                }
            } catch (error) {
                console.error('連接失敗:', error);
                showError(initResult, `連接失敗: ${error.message}`, error);
            }
        });

        // 檢查用戶是否已註冊
        async function checkUserRegistration() {
            try {
                const response = await fetch(`${scriptUrl}?action=checkRegistration&userId=${encodeURIComponent(userId)}`);
                
                if (!response.ok) {
                    throw new Error('無法連接到伺服器，請檢查網路連線');
                }
                
                const data = await response.json();
                
                if (data.success && data.registered) {
                    empId = data.empId;
                    document.getElementById('testEmpId').value = empId;
                    document.getElementById('testName').value = data.name || displayName;
                }
            } catch (error) {
                console.error('檢查註冊失敗:', error);
            }
        }

        // 獲取位置資訊
        async function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('您的瀏覽器不支持地理位置功能'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve(position);
                    },
                    (error) => {
                        let errorMessage = '獲取位置失敗: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += '用戶拒絕了位置請求';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += '位置資訊不可用';
                                break;
                            case error.TIMEOUT:
                                errorMessage += '獲取位置超時';
                                break;
                            default:
                                errorMessage += '未知錯誤';
                        }
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // 打卡功能
        async function handleCheckIn(type) {
            const name = document.getElementById('testName').value.trim();
            empId = document.getElementById('testEmpId').value.trim();
            const sheetName = document.getElementById('writeSheetName').value.trim();

            if (!name || !empId || !sheetName) {
                showResult(writeResult, '請填寫所有欄位', 'error');
                return;
            }

            if (empId.length !== 6 || !/^\d+$/.test(empId)) {
                showResult(writeResult, '員工編號必須是6位數字', 'error');
                return;
            }

            try {
                showLoading(writeResult, '正在獲取位置資訊...');
                showLoading(locationInfoDiv, '定位中...');

                // 獲取用戶位置
                const position = await getLocation();
                const { latitude, longitude, accuracy } = position.coords;
                
                locationInfoDiv.innerHTML = `
                    <strong>位置資訊:</strong><br>
                    緯度: ${latitude.toFixed(6)}<br>
                    經度: ${longitude.toFixed(6)}<br>
                    精確度: ±${accuracy.toFixed(1)} 公尺
                `;

                showLoading(writeResult, '正在提交打卡資料...');

                // 使用URLSearchParams來格式化POST數據
                const formData = new URLSearchParams();
                formData.append('action', 'checkIn');
                formData.append('type', type);
                formData.append('name', name);
                formData.append('empId', empId);
                formData.append('sheetName', sheetName);
                formData.append('latitude', latitude);
                formData.append('longitude', longitude);
                formData.append('lineUserId', userId);

                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP錯誤! 狀態碼: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    const typeText = type === 'checkIn' ? '上班' : '下班';
                    showResult(writeResult, `${typeText}打卡成功!`, 'success');
                    
                    // 顯示打卡成功訊息
                    if (liff.isInClient()) {
                        try {
                            await liff.sendMessages([
                                {
                                    type: 'text',
                                    text: `✅ ${typeText}打卡成功\n姓名: ${name}\n員工編號: ${empId}\n時間: ${new Date().toLocaleString('zh-TW')}\n位置: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`
                                }
                            ]);
                        } catch (err) {
                            console.error('發送訊息失敗:', err);
                        }
                    }
                } else {
                    throw new Error(data.message || '打卡失敗');
                }
            } catch (error) {
                console.error('打卡失敗:', error);
                showError(writeResult, error.message, error);
                locationInfoDiv.innerHTML = `<span style="color: red;">${error.message}</span>`;
            }
        }

        // 查看打卡記錄
        showRecordsBtn.addEventListener('click', async () => {
            try {
                showLoading(writeResult, '正在獲取打卡記錄...');
                
                const response = await fetch(`${scriptUrl}?action=getMyRecords&userId=${encodeURIComponent(userId)}`);
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP錯誤! 狀態碼: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    if (data.records && data.records.length > 0) {
                        displayRecords(data.records);
                        showResult(writeResult, '已載入打卡記錄', 'success');
                    } else {
                        showResult(writeResult, '今日尚無打卡記錄', 'info');
                        recordsContainer.innerHTML = '';
                    }
                } else {
                    throw new Error(data.message || '無法獲取打卡記錄');
                }
            } catch (error) {
                console.error('獲取記錄失敗:', error);
                showError(writeResult, error.message, error);
            }
        });

        // 顯示打卡記錄
        function displayRecords(records) {
            // 按時間排序 (最新的在前面)
            records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let html = '<h3>今日打卡記錄</h3>';
            records.forEach(record => {
                const typeColor = record.type === 'checkIn' ? '#38a169' : '#e53e3e';
                const typeText = record.type === 'checkIn' ? '上班打卡' : '下班打卡';
                
                html += `
                    <div class="record-item">
                        <p><strong style="color:${typeColor}">${typeText}</strong></p>
                        <p>時間: ${record.time}</p>
                        <p>位置: ${record.address || '未知位置'}</p>
                        <p>距離台北101: ${record.distance || '--'} 公尺</p>
                    </div>
                `;
            });
            
            recordsContainer.innerHTML = html;
        }

        // 綁定打卡按鈕事件
        checkInBtn.addEventListener('click', () => handleCheckIn('checkIn'));
        checkOutBtn.addEventListener('click', () => handleCheckIn('checkOut'));

        // 顯示加載狀態
        function showLoading(element, message) {
            element.innerHTML = `<span class="loading"></span> ${message}`;
            element.className = 'result info';
        }

        // 顯示結果
        function showResult(element, message, type) {
            element.innerHTML = message;
            element.className = 'result ' + type;
        }

        // 顯示錯誤詳情
        function showError(element, message, error) {
            element.innerHTML = `${message}<div class="error-details">${error.stack || error.message}</div>`;
            element.className = 'result error';
        }

        // 初始化應用
        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();
            
            // 檢查瀏覽器是否支持地理位置
            if (!navigator.geolocation) {
                locationInfoDiv.innerHTML = '<span style="color: red;">警告: 您的瀏覽器不支持地理位置功能</span>';
            }
        });
    </script>
</body>
</html>
