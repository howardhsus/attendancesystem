<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台北101大樓打卡系統</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error-box {
            background: #fdecea;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        .success-box {
            background: #e8f8f0;
            border-left: 4px solid #2ecc71;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        button {
            background: #06c755;
            color: white;
            border: none;
            padding: 12px;
            width: 100%;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
        }
        button:disabled {
            background: #ddd;
        }
        .location-status {
            padding: 15px;
            background: #ebf5fb;
            border-radius: 5px;
            margin: 15px 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>台北101大樓打卡系統</h1>
        
        <!-- 狀態顯示區 -->
        <div id="errorBox" class="error-box hidden">
            <h3>⚠️ 打卡失敗</h3>
            <p id="errorMessage"></p>
            <p><strong>建議操作：</strong></p>
            <ol>
                <li>確認網路連線正常</li>
                <li>重新整理頁面後再試</li>
                <li>檢查網址列是否為 <code>https://liff.line.me/...</code></li>
            </ol>
        </div>
        
        <div id="successBox" class="success-box hidden">
            <h3>✅ 打卡成功</h3>
            <p id="successMessage"></p>
        </div>
        
        <!-- 打卡表單 -->
        <div class="location-status">
            <p id="locationText">正在準備定位系統...</p>
            <p id="distanceText"></p>
        </div>
        
        <button id="checkInBtn" disabled>上班打卡</button>
        <button id="checkOutBtn" disabled>下班打卡</button>
        
        <div id="troubleshootTip" class="hidden">
            <h3>ℹ️ 技術提示</h3>
            <p>如持續遇到問題，可能是以下原因：</p>
            <ul>
                <li>LINE 伺服器暫時繁忙（請稍後再試）</li>
                <li>您的網路環境限制（嘗試切換網路）</li>
            </ul>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // 狀態管理
        const state = {
            isInTaipei101: false,
            lastCheckTime: null
        };

        // DOM 元素
        const elements = {
            errorBox: document.getElementById('errorBox'),
            errorMessage: document.getElementById('errorMessage'),
            successBox: document.getElementById('successBox'),
            successMessage: document.getElementById('successMessage'),
            locationText: document.getElementById('locationText'),
            distanceText: document.getElementById('distanceText'),
            checkInBtn: document.getElementById('checkInBtn'),
            checkOutBtn: document.getElementById('checkOutBtn'),
            troubleshootTip: document.getElementById('troubleshootTip')
        };

        // 初始化
        async function init() {
            try {
                await liff.init({ liffId: '2007700262-da76ZbYE' });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                // 模擬位置檢查（實際應使用瀏覽器Geolocation）
                checkLocation();
                
            } catch (error) {
                showError('LIFF初始化失敗，請關閉後重新進入');
                console.error('初始化錯誤:', error);
            }
        }

        // 位置檢查（純前端模擬）
        function checkLocation() {
            elements.locationText.textContent = "定位中...";
            
            // 模擬延遲
            setTimeout(() => {
                // 隨機模擬位置結果（開發用）
                const isInRange = Math.random() > 0.3; // 70% 機率在範圍內
                
                if (isInRange) {
                    state.isInTaipei101 = true;
                    elements.locationText.textContent = "📍 位置：台北101大樓範圍內";
                    elements.distanceText.textContent = "距離：約50公尺";
                    enableButtons();
                } else {
                    state.isInTaipei101 = false;
                    elements.locationText.textContent = "⚠️ 您不在台北101大樓範圍內";
                    elements.distanceText.textContent = "請移動至台北101大樓後重試";
                    disableButtons();
                }
            }, 1500);
        }

        // 打卡處理（純前端模擬）
        function setupCheckInButtons() {
            elements.checkInBtn.addEventListener('click', () => {
                simulateCheckIn('checkIn');
            });
            
            elements.checkOutBtn.addEventListener('click', () => {
                simulateCheckIn('checkOut');
            });
        }

        // 模擬打卡（僅前端顯示）
        function simulateCheckIn(type) {
            disableButtons();
            
            // 模擬API呼叫延遲
            setTimeout(() => {
                // 隨機模擬成功/失敗（開發用）
                const isSuccess = Math.random() > 0.3; // 70% 成功機率
                
                if (isSuccess) {
                    const time = new Date().toLocaleTimeString('zh-TW');
                    showSuccess(`${type === 'checkIn' ? '上班' : '下班'}打卡成功 (${time})`);
                    state.lastCheckTime = new Date();
                } else {
                    showError('打卡失敗：連線異常 (模擬錯誤)');
                    elements.troubleshootTip.classList.remove('hidden');
                }
                
                enableButtons();
            }, 2000);
        }

        // UI 控制函數
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorBox.classList.remove('hidden');
            elements.successBox.classList.add('hidden');
        }

        function showSuccess(message) {
            elements.successMessage.textContent = message;
            elements.successBox.classList.remove('hidden');
            elements.errorBox.classList.add('hidden');
        }

        function enableButtons() {
            if (state.isInTaipei101) {
                elements.checkInBtn.disabled = false;
                elements.checkOutBtn.disabled = false;
            }
        }

        function disableButtons() {
            elements.checkInBtn.disabled = true;
            elements.checkOutBtn.disabled = true;
        }

        // 啟動應用
        document.addEventListener('DOMContentLoaded', () => {
            init();
            setupCheckInButtons();
        });
    </script>
</body>
</html>
