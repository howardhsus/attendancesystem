<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台北101大樓打卡系統</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button, select {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        button {
            background: #06c755;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .error {
            color: #e74c3c;
            background: #fdecea;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #2ecc71;
            background: #e8f8f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            color: #3498db;
            background: #ebf5fb;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #06c755;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .user-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .location-info {
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .hidden {
            display: none;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #06c755;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading" class="container">
        <p><span class="loading"></span>系統初始化中...</p>
    </div>

    <!-- 主打卡畫面 -->
    <div id="mainApp" class="container hidden">
        <div class="user-info">
            <h2>台北101大樓打卡系統</h2>
            <p>員工: <span id="userName"></span></p>
            <p>員工編號: <span id="empId"></span></p>
        </div>

        <div class="form-group">
            <label for="checkType">打卡類型</label>
            <select id="checkType">
                <option value="checkIn">上班打卡</option>
                <option value="checkOut">下班打卡</option>
            </select>
        </div>

        <div id="locationStatus" class="info">正在獲取位置資訊...</div>
        <div id="distanceInfo" class="location-info"></div>

        <button id="submitBtn">打卡</button>
        <div id="resultMessage"></div>

        <h2>今日打卡記錄</h2>
        <div id="todayRecords"></div>
        <button id="refreshBtn">刷新記錄</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // 全局變量
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbx5I9vg9m7nTmkb0qrU8gMGXeguzVJ__ALYnqZPLdxTXTbmQr0x4voXcS_l1HpqCsw/exec'; // 替換為您的Google Apps Script部署URL
        let userId = '';
        let displayName = '';
        let userEmpId = '';

        // DOM元素
        const loadingDiv = document.getElementById('loading');
        const mainApp = document.getElementById('mainApp');
        const userNameSpan = document.getElementById('userName');
        const empIdSpan = document.getElementById('empId');
        const checkTypeSelect = document.getElementById('checkType');
        const locationStatusDiv = document.getElementById('locationStatus');
        const distanceInfoDiv = document.getElementById('distanceInfo');
        const submitBtn = document.getElementById('submitBtn');
        const resultMessageDiv = document.getElementById('resultMessage');
        const todayRecordsDiv = document.getElementById('todayRecords');
        const refreshBtn = document.getElementById('refreshBtn');

        // 初始化LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: '2007700262-da76ZbYE' }); // 替換為您的LIFF ID
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;
                
                // 檢查用戶是否已註冊
                await checkUserRegistration();
                
            } catch (error) {
                console.error('初始化失敗:', error);
                showError(loadingDiv, `系統初始化失敗: ${error.message}`);
            }
        }

        // 檢查用戶註冊狀態
        async function checkUserRegistration() {
            try {
                showLoading(loadingDiv, '檢查用戶狀態...');
                
                const response = await fetch(`${scriptUrl}?action=checkUser&lineUserId=${userId}`);
                
                if (!response.ok) {
                    throw new Error('無法檢查用戶狀態');
                }
                
                const data = await response.json();
                
                if (data.registered) {
                    // 已註冊用戶
                    userEmpId = data.empId;
                    showMainApp(data.name, data.empId);
                } else {
                    // 新用戶 - 自動註冊
                    await registerNewUser();
                }
                
            } catch (error) {
                console.error('檢查用戶狀態失敗:', error);
                showError(loadingDiv, `檢查用戶狀態失敗: ${error.message}`);
            }
        }

        // 註冊新用戶
        async function registerNewUser() {
            try {
                showLoading(loadingDiv, '註冊新員工...');
                
                // 生成6位員工編號
                const empId = generateEmpId();
                
                const formData = new URLSearchParams();
                formData.append('action', 'register');
                formData.append('lineUserId', userId);
                formData.append('name', displayName);
                formData.append('empId', empId);
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('註冊失敗');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    userEmpId = empId;
                    showMainApp(displayName, empId);
                } else {
                    throw new Error(data.message || '註冊失敗');
                }
                
            } catch (error) {
                console.error('註冊失敗:', error);
                showError(loadingDiv, `註冊失敗: ${error.message}`);
            }
        }

        // 生成6位員工編號
        function generateEmpId() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // 顯示主應用界面
        function showMainApp(name, empId) {
            loadingDiv.classList.add('hidden');
            mainApp.classList.remove('hidden');
            
            userNameSpan.textContent = name;
            empIdSpan.textContent = empId;
            
            // 初始化位置監聽
            updateLocation();
            
            // 載入今日記錄
            loadTodayRecords();
        }

        // 更新位置資訊
        async function updateLocation() {
            try {
                if (!navigator.geolocation) {
                    throw new Error('您的瀏覽器不支持地理位置功能');
                }
                
                const position = await getLocation();
                const { latitude, longitude, accuracy } = position.coords;
                
                // 計算與台北101的距離 (緯度: 25.0330, 經度: 121.5654)
                const distance = calculateDistance(
                    latitude, 
                    longitude, 
                    25.0330, 
                    121.5654
                );
                
                const locationText = `緯度: ${latitude.toFixed(6)}, 經度: ${longitude.toFixed(6)} (精確度: ±${accuracy.toFixed(1)} 公尺)`;
                const distanceText = distance <= 300 ? 
                    `您目前在台北101大樓內 (距離: ${distance.toFixed(0)} 公尺)` :
                    `您不在台北101大樓內 (距離: ${distance.toFixed(0)} 公尺)`;
                
                locationStatusDiv.innerHTML = locationText;
                distanceInfoDiv.innerHTML = distanceText;
                
                if (distance > 300) {
                    distanceInfoDiv.style.backgroundColor = '#ffebee';
                    distanceInfoDiv.style.color = '#c62828';
                } else {
                    distanceInfoDiv.style.backgroundColor = '#e8f5e9';
                    distanceInfoDiv.style.color = '#2e7d32';
                }
                
                return { latitude, longitude, distance };
                
            } catch (error) {
                console.error('獲取位置失敗:', error);
                locationStatusDiv.innerHTML = `位置獲取失敗: ${error.message}`;
                locationStatusDiv.className = 'error';
                
                distanceInfoDiv.innerHTML = '無法計算距離';
                distanceInfoDiv.style.backgroundColor = '#ffebee';
                distanceInfoDiv.style.color = '#c62828';
                
                throw error;
            }
        }

        // 獲取位置
        function getLocation() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    resolve,
                    error => {
                        let errorMessage = '獲取位置失敗: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += '用戶拒絕了位置請求';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += '位置資訊不可用';
                                break;
                            case error.TIMEOUT:
                                errorMessage += '獲取位置超時';
                                break;
                            default:
                                errorMessage += '未知錯誤';
                        }
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // 計算兩個座標之間的距離 (單位: 公尺)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // 地球半徑 (公尺)
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // 打卡按鈕點擊事件
        submitBtn.addEventListener('click', async () => {
            const checkType = checkTypeSelect.value;
            
            try {
                showLoading(submitBtn, '處理中...');
                
                // 獲取位置
                const location = await updateLocation();
                
                // 檢查是否在台北101範圍內 (300公尺內)
                if (location.distance > 300) {
                    throw new Error('您不在台北101大樓內，無法打卡');
                }
                
                // 發送打卡請求
                const formData = new URLSearchParams();
                formData.append('action', checkType);
                formData.append('lineUserId', userId);
                formData.append('latitude', location.latitude);
                formData.append('longitude', location.longitude);
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || '打卡失敗');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(resultMessageDiv, `${checkType === 'checkIn' ? '上班' : '下班'}打卡成功！`);
                    
                    // 刷新記錄
                    loadTodayRecords();
                    
                    // 發送LINE通知
                    if (liff.isInClient()) {
                        try {
                            await liff.sendMessages([
                                {
                                    type: 'text',
                                    text: `✅ ${checkType === 'checkIn' ? '上班' : '下班'}打卡成功\n姓名: ${displayName}\n員工編號: ${userEmpId}\n時間: ${new Date().toLocaleString('zh-TW')}\n位置: 台北101大樓`
                                }
                            ]);
                        } catch (err) {
                            console.error('發送訊息失敗:', err);
                        }
                    }
                } else {
                    throw new Error(data.message || '打卡失敗');
                }
                
            } catch (error) {
                console.error('打卡失敗:', error);
                showError(resultMessageDiv, `打卡失敗: ${error.message}`);
            } finally {
                submitBtn.innerHTML = checkType === 'checkIn' ? '上班打卡' : '下班打卡';
            }
        });

        // 載入今日打卡記錄
        async function loadTodayRecords() {
            try {
                todayRecordsDiv.innerHTML = '<p>載入中...</p>';
                
                const response = await fetch(`${scriptUrl}?action=getTodayRecords&lineUserId=${userId}`);
                
                if (!response.ok) {
                    throw new Error('無法獲取打卡記錄');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.records.length === 0) {
                        todayRecordsDiv.innerHTML = '<p>今日尚無打卡記錄</p>';
                    } else {
                        let html = '';
                        data.records.forEach(record => {
                            html += `
                                <div class="record">
                                    <p><strong>類型:</strong> ${record.type === 'checkIn' ? '上班' : '下班'}</p>
                                    <p><strong>日期:</strong> ${record.date}</p>
                                    <p><strong>時間:</strong> ${record.time}</p>
                                    <p><strong>位置:</strong> ${record.address || '台北101大樓'}</p>
                                </div>
                            `;
                        });
                        todayRecordsDiv.innerHTML = html;
                    }
                } else {
                    throw new Error(data.message || '獲取記錄失敗');
                }
                
            } catch (error) {
                console.error('載入記錄失敗:', error);
                todayRecordsDiv.innerHTML = `<div class="error">載入記錄失敗: ${error.message}</div>`;
            }
        }

        // 刷新記錄按鈕
        refreshBtn.addEventListener('click', loadTodayRecords);

        // 切換打卡類型時更新按鈕文字
        checkTypeSelect.addEventListener('change', function() {
            submitBtn.innerHTML = this.value === 'checkIn' ? '上班打卡' : '下班打卡';
        });

        // 顯示加載狀態
        function showLoading(element, message) {
            if (element.tagName === 'BUTTON') {
                element.innerHTML = `<span class="loading"></span> ${message}`;
            } else {
                element.innerHTML = `<div class="info"><span class="loading"></span> ${message}</div>`;
            }
        }

        // 顯示成功訊息
        function showSuccess(element, message) {
            element.innerHTML = `<div class="success">${message}</div>`;
        }

        // 顯示錯誤訊息
        function showError(element, message) {
            element.innerHTML = `<div class="error">${message}</div>`;
        }

        // 初始化應用
        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();
        });
    </script>
</body>
</html>
